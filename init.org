#+TITLE: Emacs Configuration
#+PROPERTY: header-args:elisp :tangle ~/.emacs.d/init.el
I failed in love with denote, so previous *org-roam* configs were refiled into [[file:useful-tools/old-elisps/org-roam-config.org][org-roam configs]]
* Startup configs
** UI speed up
#+begin_src elisp :tangle ~/.emacs.d/early-init.el
;;; -*- lexical-binding: t; -*-
;; set gc according to EmacsConf 2023
(setq gc-cons-threshold 8000000
      gc-cons-percentage 0.2)
(setq package-enable-at-startup nil)

;; Inhibit resizing frame
(setq frame-inhibit-implied-resize t)
;; disable warning
(setq byte-compile-warnings nil)
;; no title bar
;; (add-to-list 'default-frame-alist '(undecorated . t))
;; Faster to disable these here (before they've been initialized)
;; (push '(alpha-background . 80) default-frame-alist)
(push '(menu-bar-lines . 0) default-frame-alist)
(push '(tool-bar-lines . 0) default-frame-alist)
(push '(vertical-scroll-bars) default-frame-alist)
;; (push '(undecorated . t) default-frame-alist)
(setq initial-major-mode 'fundamental-mode ;; 默认用最简单的模式
      package--init-file-ensured t
      inhibit-startup-message t  ; 关闭启动 Emacs 时的欢迎界面
      )
;; speed font
;; (add-to-list 'default-frame-alist '(font . "Maple Mono SC NF"))

;; add support for android port of emacs
(if (eq system-type 'android)
    (progn
      (setenv "PATH" (format "%s:%s" "/data/data/com.termux/files/usr/bin"
		                     (getenv "PATH")))
      (push "/data/data/com.termux/files/usr/bin" exec-path)))

#+end_src
** basic modes
#+begin_src elisp
;;; -*- lexical-binding: t; -*-
;; basic modes

;; turn off native-comp on macos
(if (eq system-type 'darwin)
    (setq native-comp-speed -1))

(setq use-short-answers t)
(setq confirm-kill-emacs 'y-or-n-p)
(setq ring-bell-function 'ignore)
(set-default-coding-systems 'utf-8)
(setq-default indent-tabs-mode nil)

(setq next-screen-context-lines 0) ;; scroll up/down lines
(setq-default tab-width 4)
;; 平滑地进行半屏滚动，避免滚动后recenter操作
(setq scroll-step 0
      scroll-conservatively 10000)
(setq redisplay-skip-fontification-on-input t)
(setq use-dialog-box nil)               ;never pop dialog
(setq mouse-yank-at-point t)            ;粘贴于光标处,而不是鼠标指针处
#+end_src
** load-path
#+begin_src elisp
(add-to-list 'load-path (expand-file-name "lisp" user-emacs-directory))
(require 'capsule)
(capsule-initialize)
#+end_src
** set vars
I use the following file paths to manage all the files in Nowisemacs:
#+begin_example
emacs
├── 01-orgmode
│   └── xnotes
├── 02-binary-git/binary-files
│   ├── 01-pictures
│   ├── 02-searchable
│   ├── 03-stardicts
│   ├── 04-org-imagine
│   └── 10-report-backup
├── 03-bibliography
├── 04-beancount
├── 05-excalidraw
├── 06-anki
├── 07-pyim
│   └── dcache
├── 08-keys
└── 09-scripts
#+end_example
#+begin_src elisp
(defvar nowis/config-file (expand-file-name "init.org" user-emacs-directory))
(defvar nowis/config-useful-tools (expand-file-name "useful-tools/" user-emacs-directory))
(defvar nowis/doc-emacs-dir (file-truename "~/Documents/emacs/"))
(defvar nowis/gtd-dir (concat nowis/doc-emacs-dir "01-orgmode/xnotes/gtd"))
(defvar nowis/bib-dir (concat nowis/doc-emacs-dir "03-bibliography/"))
(defvar nowis/bib-pdf-dir (concat nowis/doc-emacs-dir "02-binary-git/searchable"))
#+end_src
* Package Management
** capsule
#+begin_src elisp
(setq capsule-skip-autoloads-packages '("reader"))
#+end_src
** setup
#+begin_src elisp
(require 'setup)
(setup-define :defer
  (lambda (features)
    `(run-with-idle-timer 2 nil
                          (lambda ()
                            ,features)))
  :documentation "Delay loading the feature until a certain amount of idle time has passed."
  :repeatable t)

(setup-define :autoload
  (lambda (func)
    (let ((fn (if (memq (car-safe func) '(quote function))
                  (cadr func)
                func)))
      `(unless (fboundp (quote ,fn))
         (autoload (function ,fn) ,(symbol-name (setup-get 'feature)) nil t))))
  :documentation "Autoload COMMAND if not already bound."
  :repeatable t
  :signature '(FUNC ...))
#+end_src
** other macros
#+begin_src elisp
(defmacro with-idle-delay (secs &rest body)
  "Emacs 启动并空闲 SECS 秒后执行 BODY，仅执行一次。"
  `(run-with-idle-timer
    ,secs nil
    (lambda () ,@body)))
#+end_src
* Keyboard Bindings
I used to be a vim(evil) user, but now I use meow to manage all my keys.
** meow
Maybe I should add a new state.
#+begin_src elisp
(setup meow
  (require 'meow)
  (setq meow-use-keypad-when-execute-kbd nil
        meow-expand-exclude-mode-list nil
        meow-use-clipboard t
        ;; meow-cursor-type-normal 'box
        ;; meow-cursor-type-insert '(bar . 1)
        meow-replace-state-name-list '((normal . "N")
                                       (motion . "M")
                                       (keypad . "K")
                                       (insert . "I")
                                       (beacon . "B"))
        meow-use-enhanced-selection-effect t
        meow-cheatsheet-layout meow-cheatsheet-layout-qwerty
        meow-keypad-start-keys '((?c . ?c)
                                 (?x . ?x))
        meow-char-thing-table '((?\( . round)
                                (?\) . round)
                                (?\[ . square)
                                (?\] . square)
                                (?\{ . curly)
                                (?\} . curly)
                                (?\" . string)
                                (?w . symbol)
                                ;; (?w . window)
                                (?b . buffer)
                                (?p . paragraph)
                                (?l . line)
                                (?d . defun)
                                (?s . sentence))
        )
  ;; motion keys
  (meow-motion-define-key '("j" . meow-next)
                          '("J" . meow-next-expand)
                          '("k" . meow-prev)
                          '("K" . meow-prev-expand)
                          '("h" . meow-left)
                          '("H" . meow-left-expand)
                          '("l" . meow-right)
                          '("L" . meow-right-expand)
                          '("v i" . meow-inner-of-thing)
                          '("v a" . meow-bounds-of-thing)
                          '("y" . meow-save)
                          '("<escape>" . ignore)
                          '("." . repeat)
                          '("!" . kmacro-start-macro-or-insert-counter)
                          '("@" . meow-end-or-call-kmacro)
                          )

  ;; normal keys
  (setq wrap-keymap
        (let ((map (make-keymap)))
          (suppress-keymap map)
          (dolist (k '("(" "[" "{" "<" "\"" "*"))
            (define-key map k #'insert-pair))
          map
          ))

  (meow-normal-define-key '("0" . meow-expand-0)
                          '("9" . meow-expand-9)
                          '("8" . meow-expand-8)
                          '("7" . meow-expand-7)
                          '("6" . meow-expand-6)
                          '("5" . meow-expand-5)
                          '("4" . meow-expand-4)
                          '("3" . meow-expand-3)
                          '("2" . meow-expand-2)
                          '("1" . meow-expand-1)

                          '("a" . meow-vim-append)
                          ;; '("A" . meow-append-vim)
                          '("b" . meow-back-word)
                          '("B" . meow-back-symbol)
                          '("c c" . meow-change)
                          '("d" . meow-kill)
                          '("e" . meow-next-word)
                          '("E" . meow-next-symbol)
                          '("f" . meow-find)
                          '("g" . g-extra-commands)
                          '("G" . meow-grab)
                          '("h" . meow-left)
                          '("H" . meow-left-expand)
                          '("i" . meow-insert)
                          ;; '("I" . meow-insert-vim)
                          '("j" . meow-next)
                          '("J" . meow-next-expand)
                          '("k" . meow-prev)
                          '("K" . meow-prev-expand)
                          '("l" . meow-right)
                          '("L" . meow-right-expand)
                          '("m" . consult-register-store)
                          '("M" . meow-block)
                          '("n" . meow-search)
                          '("N" . meow-pop-selection);;

                          '("o" . meow-open-below)
                          '("O" . meow-open-above)
                          '("p" . meow-yank)
                          '("P" . meow-yank-pop);;
                          '("q" . meow-quit)
                          '("Q" . consult-goto-line)
                          '("r" . meow-replace)
                          '("R" . meow-swap-grab)
                          '("s" . meow-line)
                          '("S" . meow-kmacro-lines) ;;
                          '("t" . meow-till)
                          '("u" . meow-undo)
                          '("U" . vundo)
                          '("v v" . meow-visit) ;;
                          '("V" . meow-kmacro-matches) ;;
                          '("w" . meow-mark-word)
                          '("W" . meow-mark-symbol)

                          '("x" . meow-delete)
                          '("X" . meow-backward-delete)
                          '("y" . meow-save)
                          ;; '("Y" . meow-sync-save)
                          '("z a" . hs-toggle-hiding)
                          '("z c" . hs-hide-block)
                          '("z o" . hs-show-block)
                          '("z m" . hs-hide-all)
                          '("z r" . hs-show-all)
                          '("z z" . recenter-top-bottom)

                          '("v i" . meow-inner-of-thing)
                          '("v a" . meow-bounds-of-thing)
                          '("v =" . insert-equation)

                          '("-" . negative-argument)
                          '("=" . indent-region)
                          '("(" . backward-sentence)
                          '(")" . forward-sentence)
                          '("{" . backward-paragraph)
                          '("}" . forward-paragraph)
                          ;; '("]" . nowis/graphviz-symbol-with-label)
                          ;; '("]" . (lambda()
                          ;;           (interactive)
                          ;;           (meow-bounds-of-thing ?\")))
                          (cons "\\" wrap-keymap)
                          '(";" . meow-expand-1)
                          ;; '(":" . async-shell-command)
                          '("'" . consult-register-load)
                          '("\"" . consult-register)
                          '("," . meow-reverse)
                          '("." . repeat)

                          '("<escape>" . ignore)
                          '("!" . kmacro-start-macro-or-insert-counter)
                          '("@" . meow-end-or-call-kmacro)
                          '("#" . embark-toggle-highlight)
                          '("^" . meow-join)
                          '("*" . surround-region-with-char)
                          '("/" . isearch-forward))
  (defun meow-vim-append ()
    "Like vim, move to the end of selection, switch to INSERT state."
    (interactive)
    (if meow--temp-normal
        (progn
          (message "Quit temporary normal mode")
          (meow--switch-state 'motion))
      (if (not (region-active-p))
          (progn
            (when (and meow-use-cursor-position-hack
                       (< (point) (point-max)))
              (forward-char 1))
            (forward-char 1)
            )
        (meow--direction-forward)
        (meow--cancel-selection))
      (meow--switch-state 'insert)))
  (meow-global-mode 1)

  (defun toggle-between-meow-normal-motion()
    (interactive)
    (if meow-motion-mode (meow-normal-mode) (meow-motion-mode)))
  (global-set-key (kbd "M-\\") #'toggle-between-meow-normal-motion)

  (defun surround-region-with-char (char)
    "用指定字符包围选中区域"
    (interactive "c输入包围字符: ")
    (when (use-region-p)
      (let ((start (region-beginning))
            (end (region-end)))
        (save-excursion
          (goto-char end)
          (insert char)
          (goto-char start)
          (insert char)))))
  )
#+end_src

** transient and related leader-map
*** transient
#+begin_src elisp
(setup transient
  (require 'transient)
  (:with-map transient-base-map
    (:bind "<escape>" transient-quit-one)))
#+end_src
*** g in normal mode
#+begin_src elisp
(transient-define-prefix g-extra-commands()
  "Define notes leader-key maps"
  [["Code find"
    ("d" "find-definitions" (lambda () (interactive) (call-interactively (key-binding (kbd "M-.")))))
    ("D" "find-references" xref-find-references)
    ("i" "find-impl" eglot-find-implementation)
    ("s" "find-symbols" xref-find-apropos)
    ("o" "find-def-other-window" xref-find-definitions-other-window)
    ]
   ["Code action"
    ("a" "code-actions" eglot-code-actions)
    ("r" "rename" eglot-rename)
    ("f" "format-all-region" format-all-region)
    ("F" "format-all-buffer" format-all-buffer)]
   ["diagnostic"
    ("n" "jump-to-next-diagnostic" flymake-goto-next-error)
    ("N" "jump-to-prev-diagnostic" flymake-goto-prev-error)
    ("l" "list-diagnostics" consult-flymake)
    ]
   ["Navigate"
    ("m" "consult-mark" consult-mark)
    ]
   ])
#+end_src
*** find-file
#+begin_src elisp
(transient-define-prefix file-leader-map()
  "Define leader-key map for file-related functions"
  [["config"
    ("p" "personal emacs config" (lambda()
                                   (interactive)
                                   (find-file nowis/config-file)))
    ("e" "emacs documents" (lambda()
                             (interactive)
                             (find-file nowis/doc-emacs-dir)))
    ("d" "dot files" (lambda()
                       (interactive)
                       (find-file "~/dotfiles")))
    ]
   ["history"
    ("r" "recent file" consult-recent-file)]])
#+end_src
*** lewis
#+begin_src elisp
(transient-define-prefix lewis-leader-map()
  "Define leader-key map for special functions"
  [
   ["Imenu"
    ("l" "Imenu list smart toggle" imenu-list-smart-toggle)
    ;; ("o" "org mode sidebar" nowis/org-toggle-sidebar)
    ;; ("L" "Boxy imenu" boxy-imenu)
    ]
   ["gptel"
    ("r" "gptel-rewrite" gptel-rewrite)
    ("f" "gptel-file-add" gptel-add-file)
    ]
   ["agent"
    ("p" "pi" pi)
    ("t" "pi-toggle" pi-coding-agent-toggle)
    ]
   ])
#+end_src
*** buffer
#+begin_src elisp
(transient-define-prefix buffer-leader-map()
  "Define leader-key map for buffer functions"
  [["Buffer"
    ("b" "consult-buffer" consult-buffer) ;; work with C-x b
    ("k" "kill-current-buffer" kill-current-buffer)
    ("l" "meow-last-buffer" meow-last-buffer)
    ("n" "next-buffer" next-buffer)
    ("p" "previous-buffer" previous-buffer)
    ("r" "revert-buffer" revert-buffer)
    ("c" "clean-buffer" clean-buffer-list)
    ("s" "scratch-buffer" scratch-buffer)
    ]
   ["Bookmark"
    ("j" "bookmark-jump" bookmark-jump)
    ("m" "bookmark-set" bookmark-set)
    ("M" "bookmark-delete" bookmark-delete)]
   ]
  )
#+end_src
*** notes
#+begin_src elisp
(transient-define-prefix notes-leader-map()
  "Define leader-key map for notes functions"
  [["Roam"
    ("r f" "denote-open-or-create" denote-open-or-create)
    ("r j" "denote-journal" denote-journal-new-or-existing-entry)
    ("r s" "find-all-searchable" project-find-searchable-dir-files)
    ("r c" "calendar" calendar)
    ("r g" "project-find-gtd-dir-files" project-find-gtd-dir-files)
    ]
   ["bibtex"
    ("e" "ebib" ebib)
    ("b" "citar-open" citar-open)
    ("u" "update denote with bibtex" denote-bibtex-update-reference)
    ]
   ["ladder"
    ("l c" "display current" org-ladder-display-current-status)
    ("l d" "show detailed" org-ladder-show-detailed-status)
    ("l f" "force update" org-ladder-force-refresh)
    ("l h" "history" org-ladder-show-history-review)
    ]
   ]
  )
#+end_src
*** search
#+begin_src elisp
(transient-define-prefix search-leader-map()
  "Define leader-key map for search functions"
  [
   ;; ["blink-search"
   ;;  ("b" "blink-search" blink-search)]
   ["grep"
    ("d" "consult-rg-in-dir" lewis/ripgrep-search-other-dir)
    ("D" "consult-rg" consult-ripgrep)
    ("g" "rg" rg)
    ("n" "grep-notes" lewis/ripgrep-search-notes)
    ]
   ["find"
    ("f" "consult-fd-in-dir" lewis/find-file-other-dir)
    ("F" "consult-fd" consult-fd)
    ]
   ["built-in enhance"
    ("h" "history" consult-history)
    ("i" "imenu" consult-imenu)
    ("l" "keep-lines" consult-keep-lines)
    ("s" "line" consult-line)]
   ["web search"
    ("w" "webjump" webjump)
    ("a" "add bookmark" nowis/add-bookmark)
    ("b" "browse bookmark" nowis/consult-org-bookmarks)
    ]
   ])
#+end_src
*** apps
#+begin_src elisp
(transient-define-prefix apps-leader-map()
  "Define leader-key map for apps functions"
  [["agenda"
    ("a" "org-agenda" org-agenda)
    ("A" "archive" nowis/org-archive-subtree)
    ("o" "occur" (lambda ()
                   (interactive)
                   (org-occur "^[ \t]*\\*+ +\\(TODO\\|NEXT\\)\\>")))
    ]
   ["capture"
    ("c" "capture" org-capture)
    ("e" "extract topic" org-inc-topic-capture-from-clipboard)
    ("E" "extract topic with prefix"
     (lambda () (interactive) (org-inc-topic-capture-from-clipboard '(-1))))
    ]

   ["life"
    ("l" "life" life-calendar)
    ]
   ["others"
    ("r" "restart emacs" restart-emacs)
    ("w" "whisper" whisper-run)
    ]
   ])
#+end_src
*** ui
#+begin_src elisp
(transient-define-prefix toggle-leader-map()
  "Define leader-key map for ui functions"
  [("v" "toggle-variable-pitch" variable-pitch-mode)
   ("d" "toggle-darkroom" darkroom-mode)
   ("r" "toggle-read-mode" nowis-read-mode)
    ])
#+end_src
*** tui-support
#+begin_src elisp
(unless (display-graphic-p)
  (xterm-mouse-mode 1))
#+end_src
**** clipetty
#+begin_src elisp
(setup clipetty
  (unless (display-graphic-p)
    (require 'clipetty)
    (global-clipetty-mode)
    )
  )
#+end_src
** meow leader keybindings
#+begin_src elisp
;; default
(meow-leader-define-key
 ;; Use SPC (0-9) for digit arguments.
 '("1" . meow-digit-argument)
 '("2" . meow-digit-argument)
 '("3" . meow-digit-argument)
 '("4" . meow-digit-argument)
 '("5" . meow-digit-argument)
 '("6" . meow-digit-argument)
 '("7" . meow-digit-argument)
 '("8" . meow-digit-argument)
 '("9" . meow-digit-argument)
 '("0" . meow-digit-argument)
 '("/" . meow-keypad-describe-key)
 '("?" . meow-cheatsheet)

;; buffer
;; (meow-leader-define-key
 '("b" . buffer-leader-map)
 ;; lewisliu
 '("e" . lewis-leader-map)
 ;; search
 '("s" . search-leader-map)
 ;; apps
 '("a" . apps-leader-map)
 ;; file
 '("f" . file-leader-map)
 ;; notes
 '("n" . notes-leader-map)
 ;;w workspace
 '("TAB" . tabspaces-leader-map)
 ;; ;; org gtd
 ;; '("d" . org-gtd-leader-map)
 ;; ui
 '("t" . toggle-leader-map)
 ;; '("d" . dictionary-leader-map)

 ;; org-srs review
 '("r" . org-srs-transient-map)
 )
#+end_src
** which-key
#+begin_src elisp
(setup which-key
  (setq which-key-idle-delay 0.1)
   (which-key-mode)
  )
#+end_src
** electric
#+begin_src elisp
(setup elec-pair
  (electric-pair-mode))
#+end_src
** smart-bind
#+begin_src elisp
    (defun nowis/smart-bind (key condition-fn new-fn &optional keymap)
      "Bind KEY to NEW-FN when CONDITION-FN is true, otherwise use original binding."
      (let* ((map (or keymap global-map))
             (original-binding (lookup-key map (kbd key))))
        (define-key map (kbd key)
                    (lambda ()
                      (interactive)
                      (if (funcall condition-fn)
                          (call-interactively new-fn)
                        (if original-binding
                            (call-interactively original-binding)
                          (message "No original binding for %s" key)))))))
#+end_src
* Package Library
#+begin_src elisp
(setup dash)
(setup s)
(setup f)
#+end_src
* UI
** font
#+begin_src elisp
(defun font-installed-p (font-name)
  "Check if font with FONT-NAME is available."
  (find-font (font-spec :name font-name)))

;; font size
(if (eq system-type 'darwin)
    (defvar lewis-font-size 140)
  (defvar lewis-font-size 150))

;; fixed font
(setq lewis-fixed-font (cl-loop for font in '(
                                              "JetBrains Maple Mono"
                                              "Maple Mono NF CN"
                                              "Maple Mono SC NF"
                                              "Unifont"
                                              ;; "InconsolataGo QiHei NF"
                                              ;; "yaheiInconsolata"
                                              "JetBrainsMono Nerd Font"
                                              "JetBrains Mono"
                                              "Sarasa Mono SC Nerd"
                                              "Monaco"
                                              "Consolas"
                                              )
                                when (font-installed-p font)
                                return font))
;; variable font
(setq lewis-variable-font (cl-loop for font in '(
                                                 "IBM Plex Sans"
                                                 "LXGW WenKai"
                                                 "Noto Sans CJK SC"
                                                 "PingFang SC"
                                                 "Times"
                                                 "Helvetica"
                                                 "Maple UI"
                                                 ;; "Source Han Sans SC VF"
                                                 "Arial"
                                                 "Times New Roman")
                                   when (font-installed-p font)
                                   return font))

;; chinese font
(setq lewis-chinese-font (cl-loop for font in '("Maple Mono SC NF"
                                                "Unifont"
                                                "Sarasa Mono SC Nerd"
                                                "Microsoft Yahei")
                                  when (font-installed-p font)
                                  return font))

;; symbol font
(setq lewis-symbol-font (cl-loop for font in '("Symbols Nerd Font Mono"
                                               "Symbola"
                                               "Symbol"
                                               )
                                 when (font-installed-p font)
                                 return font))

;; mayby I should remove all this font-seting and use only default font
(defun nowis/setup-fonts()
  "Setup fonts."
  (when (display-graphic-p)
    ;; Set default font
    (if lewis-fixed-font
        (progn
          (set-face-attribute 'default nil :family lewis-fixed-font :height lewis-font-size)
          ;; (set-face-attribute 'fixed-pitch nil :family lewis-fixed-font :height 1.0)
          ))

    ;; variable-pitch
    (if lewis-variable-font
        (set-face-attribute 'variable-pitch nil :family lewis-variable-font :height 1.0))

    ;; Specify font for all unicode characters
    (if lewis-symbol-font
        (set-fontset-font t 'unicode lewis-symbol-font nil 'prepend))

    ;; Specify font for Chinese characters
    ;; (if lewis-chinese-font
    ;;     (set-fontset-font t '(#x4e00 . #x9fff) lewis-chinese-font))
    )
  )

(nowis/setup-fonts)
#+end_src
** variable-pitch
#+begin_src elisp
(defun dynamic-change-line-spacing( &optional ARG)
  (if line-spacing (setq-local line-spacing nil) (setq-local line-spacing 0.5)))
(advice-add 'variable-pitch-mode :after #'dynamic-change-line-spacing)
#+end_src
** Theme
*** modus-themes
#+begin_src elisp
(setup modus-themes
  (load-theme 'modus-vivendi t)
  )
#+end_src
*** ef-themes
#+begin_src elisp
(setup ef-themes)
;; (load-theme 'ef-trio-dark t)
#+end_src
** line number
#+begin_src elisp
(setq line-number-display-limit large-file-warning-threshold)
;; only enable line number in some modes, borrowed from lazycat-emacs
(dolist (hook (list
               'prog-mode-hook
               ;;'org-mode-hook
               ))
  (add-hook hook (lambda () (display-line-numbers-mode))))
#+end_src
** nerd-icons
#+begin_src elisp
(setup nerd-icons)
#+end_src
** nerd-icons-completion
#+begin_src elisp
(setup nerd-icons-completion
  (:hook-into vertico-mode marginalia-mode))
#+end_src
** rainbow-delimiters
rainbow-delimiters is a "rainbow parentheses"-like mode which highlights delimiters such as parentheses, brackets or braces according to their depth.
#+begin_src elisp
(setup rainbow-delimiters
  (:hook-into prog-mode))
#+end_src
** diff-hl
diff-hl-mode highlights uncommitted changes on the left side of the window (area also known as the "gutter"), allows you to jump between and revert them selectively.
#+begin_src elisp
(setup diff-hl
  (:hook-into prog-mode)
  (:when-loaded
    (diff-hl-margin-mode)))
#+end_src
** fringe-mode
#+begin_src elisp
(setup fringe
  (if (featurep 'fringe)
      (fringe-mode 4)
    ))
#+end_src
** emacs-dashboard
#+begin_src elisp
(setup dashboard
  (setq dashboard-items '((recents . 5)
                          (bookmarks . 5)
                          )
        dashboard-icon-type 'nerd-icons
        dashboard-set-heading-icons t
        dashboard-set-file-icons t
        dashboard-center-content t
        dashboard-startup-banner (concat nowis/config-useful-tools "banner.txt")
        dashboard-set-init-info t)
  (dashboard-setup-startup-hook)
  )
#+end_src
*** my-simple-start
#+begin_src elisp
(add-hook 'emacs-startup-hook
          (lambda ()
            (message "Emacs loaded in %s" (emacs-init-time))))
#+end_src
** mini-echo
#+begin_src elisp
(setup hide-mode-line)
(setup mini-echo
  ;; set default segments of long/short style
  (setq mini-echo-persistent-rule
        '(:long
          ("major-mode" "vcs" "time" "flymake" "process"
           "narrow"  "profiler" "repeat" "buffer-size" "buffer-position" "buffer-percent" "shrink-path"  "meow" "macro" "org-clock" "org-timer")
          ;; remove "selection-info"
          :short
          ("major-mode" "vcs" "time" "buffer-size" "buffer-position" "shrink-path"  "meow" "macro" "org-clock" "org-timer")))
  (setq mini-echo-separator "  ")
  (setq mini-echo-window-divider-args '(t 2 2))
  (setq mini-echo-update-interval 0.04)
  (unless (display-graphic-p)
    (setq mini-echo-right-padding 1)
    )
  (mini-echo-mode -1)
  (:when-loaded
    (mini-echo-define-segment "org-clock"
      "Return org-clock."
      :fetch
      (when (and (fboundp 'org-clocking-p)
                 (org-clocking-p)
                 (not
                  (and (boundp 'org-timer-mode-line-string)
                       org-timer-start-time)))
        (let* ((time-string (org-clock-get-clock-string))
               (time-face 'mini-echo-magenta))
          (mini-echo-segment--print time-string time-face))))

    (mini-echo-define-segment "org-timer"
      "Return org-clock."
      :fetch
      (when (and (boundp 'org-timer-mode-line-string)
                 org-timer-start-time)
        (mini-echo-segment--print (concat "⏱" org-timer-mode-line-string) 'diff-added)))
    (mini-echo-define-segment "time"
      "Show the current time."
      :fetch
      (mini-echo-segment--print (format-time-string "%H:%M Day%u") 'mini-echo-green))
    (mini-echo-define-segment "buffer-percent"
      "Return the current line as a percentage of total lines in buffer."
      :fetch
      (when-let* ((total-lines (line-number-at-pos (point-max)))
                  (current-line (line-number-at-pos (point)))
                  ((> total-lines 0)))
        (format "%d%%" (/ (* current-line 100) total-lines))))
    (mini-echo-mode)
    ))
#+end_src
** hl-todo
#+begin_src elisp
(setup hl-todo
  (global-hl-todo-mode))
#+end_src
** highlight line
*** hl-line
#+begin_src elisp
(setup hl-line
  (keymap-global-set "C-l" #'nowis/recenter)
  ;; Only highliht current buffer in current window
  (setq hl-line-sticky-flag nil
        global-hl-line-sticky-flag nil)
  (global-hl-line-mode)
  (:when-loaded
    ;; update only 0.05 timer
    (defvar nowis/global-hl-line-timer nil)

    (defun nowis/global-hl-line-highlight-debounce ()
      (when nowis/global-hl-line-timer
        (cancel-timer nowis/global-hl-line-timer))
      (setq nowis/global-hl-line-timer
            (run-with-idle-timer 0.05 nil #'global-hl-line-highlight)))
    (remove-hook 'post-command-hook #'global-hl-line-highlight)
    (add-hook 'post-command-hook #'nowis/global-hl-line-highlight-debounce)

    ))
  (defun nowis/recenter ()
    (interactive)
    (call-interactively 'recenter)
    (pulsar-pulse-line))
  (defvar my-hl-line-timer nil)
#+end_src
*** pulsar
#+begin_src elisp
(setup pulsar
  (pulsar-global-mode 1)
  (setq pulsar-delay 0.015
        pulsar-iterations 10)
  (:when-loaded
    (add-hook 'pulsar-pulse-functions 'ace-window)))
#+end_src
** show-paren-mode
#+begin_src elisp
(setup paren
  (setq show-paren-context-when-offscreen 'child-frame))
#+end_src
* General Configuration
** simple
#+begin_src elisp
(setup simple
  ;; show line/column/filesize in modeline
  (setq line-number-mode t
        column-number-mode t
        size-indication-mode t
        kill-do-not-save-duplicates t
        shell-command-prompt-show-cwd t
        what-cursor-show-names t)
  ;; (add-hook 'org-mode-hook 'turn-on-auto-fill)

  ;; (global-visual-line-mode)
  (dolist (hook (list
                 'prog-mode-hook
                 'org-mode-hook
                 'vterm-mode-hook
                 ))
    (add-hook hook (lambda () (visual-line-mode))))
  )
#+end_src
** general builtin modes
#+begin_src elisp
(setup save-place
   (save-place-mode)
  )

(setup autorevert
  (setq global-auto-revert-non-file-buffers t)
  (global-auto-revert-mode t)); 当另一程序修改了文件时，让 Emacs 及时刷新 Buffer

(setup frame
  (blink-cursor-mode -1) ;指针不闪动
  )
#+end_src
** repeat-mode
#+begin_src elisp
(setup repeat
  (repeat-mode))
#+end_src
** backup
*** auto-save
#+begin_src elisp
(setup auto-save
  (setq auto-save-default nil
        create-lockfiles nil
        make-backup-files nil
        auto-save-visited-interval 1)
  (auto-save-visited-mode)
  )
#+end_src
*** savehist
#+begin_src elisp
(setup savehist
  (setq history-length 100
        history-delete-duplicates t
        savehist-save-minibuffer-history t)
  (savehist-mode))
#+end_src
** no-littering
#+begin_src elisp
(setup no-littering
   (require 'no-littering)
  )
#+end_src
** recentf
#+begin_src elisp
(setup recentf
  (setq recentf-max-saved-items 100
        recentf-exclude `("/tmp/" "/ssh:" ,(concat user-emacs-directory "lib/.*-autoloads\\.el\\'")))
  (add-to-list 'recentf-exclude no-littering-var-directory)
  (add-to-list 'recentf-exclude no-littering-etc-directory)
  (with-idle-delay 2
     (recentf-mode))
  )
#+end_src
** 自动换行
#+begin_src elisp
(setq-default fill-column 100)
(setq word-wrap t)
(setq word-wrap-by-category t)
#+end_src
** long-line
#+begin_src elisp
(setq-default bidi-display-reordering nil)
(setq bidi-inhibit-bpa t
      long-line-threshold 1000
      large-hscroll-threshold 1000
      syntax-wholeline-max 1000)
#+end_src
** TRAMP
#+begin_src elisp
(setq tramp-default-method "ssh")
#+end_src
** tramp-rpc
#+begin_src elisp
(setup msgpack)
(setup tramp-rpc)
#+end_src
** Automatically clean whitespace
#+begin_src elisp
(setup ws-butler
  (:hook-into text-mode prog-mode))
#+end_src
** vundo for undo history
#+begin_src elisp
(setup vundo
  (setq undo-limit (* 64 1024 1024)
        undo-strong-limit (* 96 1024 1024)
        undo-outer-limit (* 960 1024 1024)
        )
  (:bind "l" vundo-forward
         "h" vundo-backward
         "j" vundo-next
         "k" vundo-previous))
#+end_src
* Search
** isearch
#+begin_src elisp
(setup isearch
  (setq isearch-lazy-count t
        ;; lazy-highlight-cleanup nil
        )
  (:bind [remap isearch-delete-char] isearch-del-char)
  (:when-loaded
    (defvar isearch-repeat-map
      (let ((map (make-sparse-keymap)))
        (define-key map (kbd "s") #'isearch-repeat-forward)
        (define-key map (kbd "r") #'isearch-repeat-backward)
        map))
    (dolist (cmd '(isearch-repeat-forward isearch-repeat-backward))
      (put cmd 'repeat-map 'isearch-repeat-map))

    ))
#+end_src
** Consult Commands
*** consult
#+begin_src elisp
(setup consult
  (keymap-global-set "C-x b" #'consult-buffer)
  (setq register-preview-delay 0.1
        register-preview-function #'consult-register-format
        xref-show-xrefs-function #'consult-xref
        xref-show-definitions-function #'consult-xref
        )
  (:with-map minibuffer-local-map
    (:bind "C-r" consult-history)))
#+end_src
*** search other cwd
#+begin_src elisp
(defun lewis/ripgrep-search-other-dir()
  (interactive)
  (let ((current-prefix-arg '(-1)))
    (call-interactively 'consult-ripgrep)))

(defun lewis/ripgrep-search-notes()
  (interactive)
  (consult-ripgrep (concat nowis/doc-emacs-dir "01-orgmode")))

(defun lewis/find-file-other-dir()
  (interactive)
  (let ((current-prefix-arg '(-1)))
    (call-interactively 'consult-fd)))
#+end_src
*** consult-dir
#+begin_src elisp
(setup consult-dir
  (define-key global-map (kbd "C-x C-d") #'consult-dir)
  (define-key minibuffer-local-completion-map (kbd "C-x C-d") #'consult-dir)
  (:when-loaded

    ;; add support for zoxide
    (setq consult-dir-default-command #'consult-dir-dired)

    (defun consult-dir--zoxide-dirs ()
      "Return list of zoxide dirs."
      (split-string (shell-command-to-string "zoxide query -l") "\n" t))

    (defvar consult-dir--source-zoxide
      `(:name "zoxide"
              :narrow ?z
              :category file
              :face consult-file
              :history file-name-history
              :enabled ,(lambda () (executable-find "zoxide"))
              :items ,#'consult-dir--zoxide-dirs)
      "zoxide directory source for `consult-dir'.")

    (add-to-list 'consult-dir-sources 'consult-dir--source-zoxide t)
    ))
#+end_src
*** consult-omni
#+begin_src elisp
(setup consult-omni
  (:when-loaded
    (require 'consult-omni-embark)
    (require 'consult-omni-sources)
    (setq consult-omni-sources-modules-to-load '(consult-omni-google consult-omni-bing))
    (consult-omni-sources-load-modules)
    )
  )
#+end_src
** rg.el
#+begin_src elisp
(setup rg)
#+end_src
* 补全
** default completion comfigurations
#+begin_src elisp
(setq completions-detailed t) ;;useful in emacs 28
(setq completions-group t)
(setq completions-sort 'historical)
#+end_src
** Completions with Vertico
#+name: vertico
#+begin_src elisp
(setq vertico-cycle t)
(setup vertico
  (:with-map vertico-map
    (:bind [backspace] vertico-directory-delete-char
           "DEL" vertico-directory-delete-char
           ))
  (vertico-mode))
#+end_src
** icomplete
#+begin_src elisp :tangle no
(setup icomplete
  (setq icomplete-scroll t
        icomplete-hide-common-prefix nil
        icomplete-show-matches-on-no-input t
        icomplete-prospects-height 1
        icomplete-separator " "
        )
  (icomplete-vertical-mode)

  (:when-loaded
    (keymap-set icomplete-minibuffer-map "TAB" #'icomplete-force-complete)
    (keymap-set icomplete-minibuffer-map "DEL" #'icomplete-fido-backward-updir)
    (keymap-set icomplete-minibuffer-map "RET" #'icomplete-force-complete-and-exit)
    ;; (keymap-set icomplete-minibuffer-map "C-s" #'icomplete-forward-completions)
    ;; (keymap-set icomplete-minibuffer-map "C-r" #'icomplete-backward-completions)
    ))
#+end_src
** flex
#+begin_src elisp :tangle no
(setq completion-styles '(basic partial-completion flex)
      completion-cycling t
      )
#+end_src
** Orderless and pinyinlib
#+begin_src elisp
(setup orderless
  (setq completion-styles '(orderless basic)
        completion-category-defaults nil
        completion-category-overrides '((file (styles partial-completion)))
        completion-pcm-leading-wildcard t
        )
  (:when-loaded
    (require 'pinyinlib)
    (defun completion--regex-pinyin (str)
      (orderless-regexp (pinyinlib-build-regexp-string str)))
    (add-to-list 'orderless-matching-styles 'completion--regex-pinyin)
    ))
#+end_src
** Marginalia
#+begin_src elisp
(setup marginalia
  (:hook-into after-init))
#+end_src
** embark
should be check after reading the embark.el manual
#+begin_src elisp
(setup embark-consult
  (add-hook 'embark-collect-mode-hook #'consult-preview-at-point-mode))

(setup embark
  (:also-load embark-consult)
  (:autoload embark-toggle-highlight)
  (setq prefix-help-command #'embark-prefix-help-command)
  (keymap-global-set "C-S-a" #'embark-act))

(setup wgrep)

;; open pdf with zathura
(defun nowis/open-with-zathura (file)
  "Open FILE with zathura."
  (start-process "zathura" nil "zathura" file))

(with-eval-after-load 'embark
  (define-key embark-file-map (kbd "z") #'nowis/open-with-zathura))
#+end_src
** yasnippet
#+begin_src elisp
(setup yasnippet
  (keymap-global-set "M-*" #'yas-insert-snippet)
  (setq yas-snippet-dirs (list (concat nowis/config-useful-tools "snippets")))
  (with-idle-delay 2
    (yas-global-mode))
  )
#+end_src
* Window Management
** window
#+begin_src elisp
(setup window
  (setq quit-restore-window-no-switch t)
  )
#+end_src
** winner-mode
#+begin_src elisp
(setup winner
  (winner-mode t))
#+end_src
** popper
Popper is a minor-mode to tame the flood of ephemeral windows Emacs produces, while still keeping them within arm’s reach.
#+begin_src elisp
(setup popper
  (setq popper-reference-buffers '("\\*Messages\\*"
                                   "Output\\*$"
                                   "\\*Async Shell Command\\*"
                                   "\\*Org Clock Reminder\\*"
                                   "gt-result"
                                   help-mode
                                   helpful-mode
                                   compilation-mode
                                   youdao-dictionary-mode)
        popper-window-height 0.33
        )
  (keymap-global-set "M-~" #'popper-toggle)
  (keymap-global-set "C-M-`" #'popper-toggle-type)
  (popper-mode +1)
  (popper-echo-mode +1))
#+end_src
** Move
*** avy
Jump anywhere in the world
#+begin_src elisp
(setup avy
  (keymap-global-set "M-j" #'avy-goto-char-timer)
  ;; (setq avy-keys (number-sequence ?1 ?9))
  (:when-loaded
  (defun avy-action-embark (pt)
    (unwind-protect
        (save-excursion
          (goto-char pt)
          (embark-act))
      (select-window
       (cdr (ring-ref avy-ring 0))))
    t)

  (setf (alist-get ?. avy-dispatch-alist) 'avy-action-embark)
  (define-key isearch-mode-map (kbd "M-j") 'avy-isearch)
  ))
#+end_src
*** bookmark
#+begin_src elisp
(setq bookmark-default-file (concat nowis/doc-emacs-dir "bookmarks"))
#+end_src
*** windmove
#+begin_src elisp
(setup windmove
  (transient-define-prefix windmove-transient-keybindings()
    "Define windmove maps"
    [[("h" "left" windmove-left :transient t)
      ("H" "swap-left" windmove-swap-states-left :transient t)]
     [("j" "down" windmove-down :transient t)
      ("J" "swap-down" windmove-swap-states-down :transient t)]
     [("k" "up" windmove-up :transient t)
      ("K" "swap-up" windmove-swap-states-up :transient t)]
     [("l" "right" windmove-right :transient t)
      ("L" "swap-right" windmove-swap-states-right :transient t)]
     ])
  (keymap-global-set "C-x O" #'windmove-transient-keybindings)
  )

#+end_src
*** ace-window
#+begin_src elisp
(setup ace-window
  (keymap-global-set "M-o" #'ace-window))
(setq aw-keys '(?a ?s ?d ?f ?g ?h ?j ?k ?l)
      aw-scope 'frame
      )
(defun ace-window-prefix ()
  (interactive)
  (display-buffer-override-next-command
   (lambda (buffer _)
     (let (window type)
       (setq
        window (aw-select (propertize " ACE" 'face 'mode-line-highlight))
        type 'reuse)
       (cons window type)))
   nil "[ace-window]")
  (message "Use `ace-window' to display next command buffer..."))
;; (keymap-global-set "C-x 4 o" 'ace-window-prefix)
  (keymap-global-set "M-O" #'ace-window-prefix)
#+end_src
* ibuffer
** ibuffer
#+begin_src elisp
(setup ibuffer
  (global-set-key [remap list-buffers] #'ibuffer))
#+end_src
* Input
** posframe
#+begin_src elisp
(setup posframe)
#+end_src
** rime
#+begin_src elisp
(setq default-input-method "rime")
(with-eval-after-load 'rime
  (defun nowis/rime-disable-predicates ()
    (if (derived-mode-p 'eat-mode)
        ;; 只在 eat buffer 下，禁用 predicates 约束，rime 全时可用
        '(meow-normal-mode-p
          meow-motion-mode-p
          meow-keypad-mode-p
          rime-predicate-after-alphabet-char-p
          rime-predicate-current-input-punctuation-p
          rime-predicate-current-uppercase-letter-p
          rime-predicate-space-after-cc-p
          )
      ;; 其他 buffer 用你原来的 predicate 约束
      '(meow-normal-mode-p
        meow-motion-mode-p
        meow-keypad-mode-p
        rime-predicate-prog-in-code-p
        rime-predicate-punctuation-line-begin-p ;;在行首要输入符号时
        rime-predicate-after-alphabet-char-p ;;在英文字符串之后（必须为以字母开头的英文字符串）
        rime-predicate-current-input-punctuation-p ;;当要输入的是符号时
        ;; rime-predicate-after-ascii-char-p ;;任意英文字符后 ,enable this to use with <s
        rime-predicate-current-uppercase-letter-p ;; 将要输入的为大写字母时
        rime-predicate-space-after-cc-p ;;在中文字符且有空格之后
        )))
  (add-hook 'rime-mode-hook
            (lambda ()
              (setq-local rime-disable-predicates
                          (funcall #'nowis/rime-disable-predicates))))

  (setq rime-show-candidate 'posframe
        rime-posframe-properties (list :internal-border-width 1
                                       :font lewis-fixed-font)
        rime-user-data-dir "~/Documents/rime/"
        rime-share-data-dir "~/Documents/rime/"
        rime-inline-ascii-trigger 'shift-r
        )
  ;; (add-hook 'kill-emacs-hook #'rime-lib-finalize)
  )
(when (eq system-type 'darwin)
  (setq
   rime-emacs-module-header-root "/Applications/Emacs.app/Contents/Resources/include/" ;; use build-emacs
   ;; rime-emacs-module-header-root "/opt/homebrew/opt/emacs-plus@31/include" ;;use emacs-plus
   ;; rime-librime-root "~/Downloads/librime/dist"
   rime-librime-root "/opt/homebrew/opt/librime/"
   ))
#+end_src
* File and Browsing
** file browsing
*** dired
#+begin_src elisp
(setup dired
  (setq dired-dwim-target t)
  (:hook dired-hide-details-mode
         ;; dired-omit-mode
         ))
#+end_src
*** nerd-icons-dired
#+begin_src elisp
(setup nerd-icons-dired)
(add-hook 'dired-mode-hook #'nerd-icons-dired-mode)
#+end_src
*** dired-hacks
#+begin_src elisp
(setup dired
  (:with-map dired-mode-map
    (:bind "TAB" #'dired-subtree-toggle))
  )
#+end_src
*** dired-sidebar
#+begin_src elisp
(setup dired-sidebar)
#+end_src
** structure browsing
*** imenu-list
#+begin_src elisp
(setup imenu-list
  (:autoload imenu-list-smart-toggle)
  (setq imenu-list-focus-after-activation nil
           imenu-list-auto-resize t
           imenu-list-position 'left
           imenu-list-auto-update t
           )
  )
#+end_src
** tab-line and tab-bar
#+begin_src elisp
(setup tab-bar
  (setq tab-bar-new-button-show nil
        tab-bar-close-button-show nil)
  )
(setup tab-line
  (setq tab-line-new-button-show nil
           tab-line-close-button-show nil)
  ;; (:defer (global-tab-line-mode))
  )
#+end_src
** tabspaces
#+begin_src elisp
(setup tabspaces
  (setq tabspaces-use-filtered-buffers-as-default t
        tabspaces-keymap-prefix nil)
(with-idle-delay 2
   (tabspaces-mode))
  (:when-loaded
    (transient-define-prefix tabspaces-leader-map()
      "Define tabspaces leader-key maps"
      [["Create or close"
        ("s" "tabspaces-switch-or-create-workspace" tabspaces-switch-or-create-workspace)
        ("b" "tabspaces-switch-to-buffer" tabspaces-switch-to-buffer)
        ("d" "tabspaces-close-workspace" tabspaces-close-workspace)
        ("k" "tabspaces-remove-selected-buffer" tabspaces-remove-selected-buffer)
        ("r" "tab-bar-rename-tab-by-name" tab-bar-rename-tab-by-name)
        ]
       ["Switch tab bar"
        ("n" "tab-bar-switch-to-next-tab" tab-bar-switch-to-next-tab)
        ("p" "tab-bar-switch-to-prev-tab" tab-bar-switch-to-prev-tab)
        ("l" "tab-bar-switch-to-last-tab" tab-bar-switch-to-last-tab)
        ]
       ]
      )
    )
  )
#+end_src
** project
#+begin_src elisp
(setup project
  (:when-loaded
    (add-to-list 'project-find-functions #'project-rootfile-try-detect)
    )
  )
#+end_src
** project-rootfile
#+begin_src elisp
(setup project-rootfile
  (setq project-rootfile-list '(".project"))
  )
#+end_src
** auto-insert
#+begin_src elisp
(setup autoinsert
  (setq auto-insert-query t)
  ;; (:defer
  ;;  (auto-insert-mode t))
  )
#+end_src
** midnight
#+begin_src elisp
(setup midnight)
(setq clean-buffer-list-delay-general 1)
#+end_src
* shell
** eshell
#+begin_src elisp
(setup eshell)
#+end_src
** eat
#+begin_src elisp
(defun meomacs-eat-meow-setup()
  (add-hook 'meow-normal-mode-hook 'eat-emacs-mode nil t)
  (add-hook 'meow-insert-mode-hook 'eat-semi-char-mode nil t))

(with-eval-after-load "meow"
  (with-eval-after-load "eat"
    (keymap-set eat-char-mode-map "C-S-v" 'eat-yank)
    (add-hook 'eat-mode-hook 'meomacs-eat-meow-setup)))

(setup eat
  (when (eq system-type 'darwin)
    (setq eat-term-name "xterm-256color"))
  (keymap-global-set "M-`" #'eat-toggle-window)
  (:when-loaded
    (add-to-list 'display-buffer-alist
                 '((lambda (buffer-or-name _)
                     (let ((buffer (get-buffer buffer-or-name)))
                       (with-current-buffer buffer
                         (or (equal major-mode 'eat-mode)
                             (string-prefix-p "*eat" (buffer-name buffer))))))
                   (display-buffer-reuse-window display-buffer-at-bottom)
                   (reusable-frames . visible)
                   (window-height . 0.3)))
    (add-to-list 'eat-semi-char-non-bound-keys [?\e ?o])
    (eat-update-semi-char-mode-map)))
(defun eat-toggle-window(&optional choose-buffer)
  "Toggle eat buffer window or select from multiple buffers."
  (interactive "P")
  (let ((eat-win (seq-find (lambda (w)
                             (eq 'eat-mode (buffer-local-value 'major-mode (window-buffer w))))
                           (window-list)))
        (eat-buffers (eat--get-buffers)))
    (if eat-win
        (delete-window eat-win)
      (if (or choose-buffer (> (length eat-buffers) 1))
          (eat--prompt-select-or-create)
        (if-let ((buf (car eat-buffers)))
            (pop-to-buffer buf)
          (eat--create-new-buffer))))))

(defun eat--prompt-select-or-create ()
  "Prompt user to select an existing eat buffer or type a new name to create one."
  (let* ((eat-buffers (eat--get-buffers))
         (existing-bufs (mapcar #'buffer-name eat-buffers))
         (choice (completing-read "Select or create eat buffer: " existing-bufs nil nil)))
    (let ((buf (get-buffer choice)))
      (if buf
          (pop-to-buffer buf)
        (eat--create-new-buffer choice)))))

(defun eat--create-new-buffer (&optional buffer-name)
  "Create a new eat buffer with optional BUFFER-NAME and open it."
  (unless (featurep 'eat)
    (require 'eat)
    (eat-reload))
  (if buffer-name
      (let ((eat-buffer-name buffer-name))
        (eat))
    (eat)))

(defun eat--get-buffers ()
  "Return live eat buffers."
  (seq-filter (lambda (b)
                (and (buffer-live-p b)
                     (eq 'eat-mode (buffer-local-value 'major-mode b))))
              (buffer-list)))


#+end_src
* git
** magit
#+begin_src elisp
(setup with-editor)
(setup llama)
(setup cond-let)
(setup magit)
#+end_src
** ediff
#+begin_src elisp
(setup ediff
  (setq ediff-split-window-function 'split-window-horizontally
           ediff-window-setup-function 'ediff-setup-windows-plain)
  ;; restore windows Configuration after ediff
  (add-hook 'ediff-before-setup-hook #'ediff-save-window-conf)
  (add-hook 'ediff-quit-hook #'ediff-restore-window-conf)
  (:when-loaded
    (defvar local-ediff-saved-window-conf nil)
    (defun ediff-save-window-conf ()
      (setq local-ediff-saved-window-conf (current-window-configuration)))
    (defun ediff-restore-window-conf ()
      (when (window-configuration-p local-ediff-saved-window-conf)
        (set-window-configuration local-ediff-saved-window-conf)))
    ))
#+end_src
* Program
** Language
*** elisp
#+begin_src elisp
(setq elisp-fontify-semantically t)
#+end_src
**** helpful
#+begin_src elisp
(setup elisp-refs)
(setup helpful
  (keymap-global-set "C-h f" #'helpful-callable)
  (keymap-global-set "C-h v" #'helpful-variable)
  (keymap-global-set "C-h k" #'helpful-key)
  (keymap-global-set "C-c C-d" #'helpful-at-point)
  (keymap-global-set "C-h F" #'helpful-function)
  (keymap-global-set "C-h C" #'helpful-command))
#+end_src
**** elisp-demos
#+begin_src elisp
(setup elisp-demos
  (advice-add 'helpful-update :after #'elisp-demos-advice-helpful-update))
#+end_src
*** graphviz-dot-mode
#+begin_src elisp
(setup graphviz-dot-mode
  (add-to-list 'auto-mode-alist '("\\.dot\\'" . graphviz-dot-mode))
  (setq graphviz-dot-indent-width 4)
    )
#+end_src
*** plantuml
This Emacs tool use plantuml to generate images for org, json, yaml files.
#+begin_src elisp
;; download plantuml jar
(setq plantuml-jar-path (concat no-littering-var-directory "plantuml.jar"))
(defun plantuml-download-jar ()
  "Download the latest PlantUML JAR file and install it into `plantuml-jar-path'."
  (interactive)
  (if (y-or-n-p (format "Download the latest PlantUML JAR file into %s? " plantuml-jar-path))
      (if (or (not (file-exists-p plantuml-jar-path))
              (y-or-n-p (format "The PlantUML jar file already exists at %s, overwrite? " plantuml-jar-path)))
          (with-current-buffer (url-retrieve-synchronously "https://search.maven.org/solrsearch/select?q=g:net.sourceforge.plantuml+AND+a:plantuml&core=gav&start=0&rows=1&wt=xml")
            (mkdir (file-name-directory plantuml-jar-path) t)
            (let* ((parse-tree (xml-parse-region))
                   (doc        (->> parse-tree
                                    (assq 'response)
                                    (assq 'result)
                                    (assq 'doc)))
                   (strs       (xml-get-children doc 'str))
                   (version    (->> strs
                                    (--filter (string-equal "v" (xml-get-attribute it 'name)))
                                    (car)
                                    (xml-node-children)
                                    (car))))
              (message (concat "Downloading PlantUML v" version " into " plantuml-jar-path))
              (url-copy-file (format "https://search.maven.org/remotecontent?filepath=net/sourceforge/plantuml/plantuml/%s/plantuml-%s.jar" version version) plantuml-jar-path t)
              (kill-buffer)))
        (message "Aborted."))
    (message "Aborted.")))
#+end_src
*** beancount
Emacs major-mode to work with Beancount ledger files
#+begin_src elisp
(setup beancount
  (:match-file "\\.beancount\\'"))
#+end_src
*** latex
**** basic
#+begin_src elisp
;;  (setup auctex)
(setup cdlatex)
#+end_src
*** python
**** python
#+begin_src elisp
(setup python
  (:with-hook inferior-python-mode-hook
    (:hook (lambda ()
             (process-query-on-exit-flag
              (get-process "Python")))))
  (:when-loaded
    (when (and (executable-find "python3")
               (string= python-shell-interpreter "python"))
      (setq python-shell-interpreter "python3"))
    (with-eval-after-load 'exec-path-from-shell
      (exec-path-from-shell-copy-env "PYTHONPATH"))
    ))
#+end_src
*** scheme
#+begin_src elisp
(setup geiser)
(add-to-list 'load-path (expand-file-name "lib/geiser/elisp" user-emacs-directory))
(setup geiser-guile)
#+end_src
*** cc-mode
#+begin_src emacs-lisp
(setup cc-mode
  (setq c-basic-offset 4))

(setup hideif
  (setq hide-ifdef-shadow t
           hide-ifdef-initially t)
  (:with-feature hide-ifdef-mode
    (:hook-into c-mode c++-mode)))
#+end_src
*** lua-mode
#+begin_src elisp
(setup lua-mode)
#+end_src
*** cmake-mode
#+begin_src elisp
(setup cmake-mode)
#+end_src
*** csv-mode
#+begin_src elisp
(setup csv-mode)
#+end_src
** Useful programing tools
*** xref related
**** xref
#+begin_src elisp
(setup xref
  (setq xref-search-program (cond
                             ((executable-find "rg") 'ripgrep)
                             (t 'grep))
        xref-history-storage #'xref-window-local-history)
  ;; (:autoload xref-push-marker-stack nil t)
  (require 'xref)
  ) ;; autoload this command for jump-back
#+end_src
**** xref jump back
borrowed from citre, now you can always jump-back use "M-," after any jump in the list.
#+begin_src elisp
(defun my--push-point-to-xref-marker-stack (&rest r)
  (xref-push-marker-stack (point-marker))) ;; must autoload this command in xref
(dolist (func '(find-function
                consult-imenu
                consult-ripgrep
                consult-line
                consult-find
                find-file
                consult-goto-line
                isearch-forward))
  (if (fboundp func)
      (advice-add func :before 'my--push-point-to-xref-marker-stack)))
#+end_src
*** UI
**** electric-pair
#+begin_src elisp
(setup elec-pair
  (electric-pair-mode))
#+end_src
**** indent-bars
#+begin_src elisp
(setup indent-bars
  (:hook-into prog-mode)
  )
#+end_src
**** breadcrumb
#+begin_src elisp
(setup breadcrumb
  (setq breadcrumb-idle-time 2
        breadcrumb-imenu-crumb-separator "  "
        breadcrumb-imenu-max-length 0.6
        )
  (breadcrumb-mode)
  )
#+end_src
*** treesit tools
**** treesit
#+begin_src elisp
(setup treesit
  (setq treesit-font-lock-level 4)

  ;; avoid some errors without treesit
  (if (not (treesit-available-p))
      (setq treesit-extra-load-path (list (concat user-emacs-directory "var/treesit/")))
    )
  (when (treesit-available-p)
    ;; configure sources
    (setq treesit-auto-install-grammar 'ask
          major-mode-remap-alist treesit-major-mode-remap-alist
          treesit-language-source-alist
          '((bash "https://github.com/tree-sitter/tree-sitter-bash")
            (c "https://github.com/tree-sitter/tree-sitter-c")
            (cpp "https://github.com/tree-sitter/tree-sitter-cpp")
            (cmake "https://github.com/uyha/tree-sitter-cmake")
            (css "https://github.com/tree-sitter/tree-sitter-css")
            (elisp "https://github.com/Wilfred/tree-sitter-elisp")
            (go "https://github.com/tree-sitter/tree-sitter-go")
            (html "https://github.com/tree-sitter/tree-sitter-html")
            (javascript "https://github.com/tree-sitter/tree-sitter-javascript" "master" "src")
            (json "https://github.com/tree-sitter/tree-sitter-json")
            (make "https://github.com/alemuller/tree-sitter-make")
            (python "https://github.com/tree-sitter/tree-sitter-python")
            (toml "https://github.com/tree-sitter/tree-sitter-toml")
            (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
            (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
            (yaml "https://github.com/ikatyang/tree-sitter-yaml")))
    (defun treesit-install-all()
      (interactive)
      (mapc #'treesit-install-language-grammar (mapcar #'car treesit-language-source-alist))
      )
    )
  )
#+end_src
*** Complete
**** corfu related
***** corfu
#+begin_src elisp
(defun corfu-enable-in-minibuffer ()
  "Enable Corfu in the minibuffer."
  (when (local-variable-p 'completion-at-point-functions)
    ;; (setq-local corfu-auto nil) ;; Enable/disable auto completion
    (setq-local corfu-echo-delay nil ;; Disable automatic echo and popup
                corfu-popupinfo-delay nil)
    (corfu-mode 1)))
(add-hook 'minibuffer-setup-hook #'corfu-enable-in-minibuffer)

(setq text-mode-ispell-word-completion nil)
(setup corfu
  (setq corfu-cycle t                ;; Enable cycling for `corfu-next/previous'
        corfu-auto t                 ;; Enable auto completion
        corfu-quit-no-match t        ;; Automatically quit if there is no match
        corfu-preview-current nil    ;; Disable current candidate preview
        corfu-auto-prefix 1
        corfu-auto-delay 0.05
        corfu-scroll-margin 5
        )        ;; Use scroll margin
  (:with-map corfu-map
    (:bind "<escape>" my-corfu-quit
           "C-SPC" corfu-insert-separator
           ))

  (defun my-corfu-quit()
    "when in corfu-map, quit corfu-selection and return to meow normal mode"
    (interactive)
    (corfu-quit)
    (meow-insert-exit))

  (global-corfu-mode)
  )
(setup corfu-popupinfo
  (setq corfu-popupinfo-delay '(0.5 . 0.5))
  (:hook-into corfu))

(setup cape
  ;; don't let dabbrev take over all things
  (defalias 'cape-dabbrev-min-2 (cape-capf-prefix-length #'cape-dabbrev 2))
  ;; (add-to-list 'completion-at-point-functions #'cape-dabbrev)
  (add-to-list 'completion-at-point-functions #'cape-dabbrev-min-2)
  (add-to-list 'completion-at-point-functions #'cape-elisp-block)
  (add-to-list 'completion-at-point-functions #'cape-dict)
  (add-to-list 'completion-at-point-functions #'cape-file)
  )

#+end_src
***** ispell
#+begin_src elisp
(setup ispell
  (:when-loaded
    ;; if not find ispell-dict, use cape as default
    (if (null ispell-alternate-dictionary)
        (progn
          (setq ispell-complete-word-dict (concat nowis/doc-emacs-dir "02-binary-git/binary-files/12-spell-dict/en_US.dict"))))))
#+end_src
***** nerd-icons-corfu
#+begin_src elisp
(setup nerd-icons-corfu
  (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))
#+end_src
**** lsp mode
***** eglot
#+begin_src elisp
(setup project)
(setq read-process-output-max (* 1024 1024))
(setup eglot
  (setq eglot-events-buffer-config'(:size 20000 :format full)
        eglot-extend-to-xref t
        ;; eglot-workspace-configuration '((:python.analysis :useLibraryCodeForTypes t))
        )
  (:autoload eglot-find-implementation)
  (add-hook 'prog-mode-hook (lambda ()
                              (unless
                                  (or (file-remote-p default-directory)
                                      (derived-mode-p 'emacs-lisp-mode 'lisp-mode 'makefile-mode 'snippet-mode)
                                      (eglot-ensure)))))

  (:when-loaded
    ;; hightlight face
    (defface new-hi-green
      '((((min-colors 88) (background dark))
         (:background "light green" :foreground "black"))
        (((background dark)) (:background "green" :foreground "black"))
        (((min-colors 88)) (:background "light green"))
        (t (:background "green")))
      "Face for hi-lock mode.")
    (set-face-attribute 'eglot-highlight-symbol-face nil :inherit 'new-hi-green)
    ;; more languare server
    (add-to-list 'eglot-server-programs
                 '(graphviz-dot-mode . ("dot-language-server" "--stdio")))
    )
  )
(setup eldoc
  (setq eldoc-echo-area-use-multiline-p nil
        eldoc-echo-area-display-truncation-message t))
;; (setq eldoc-echo-area-prefer-doc-buffer nil)
#+end_src
***** eglot in org-src
#+begin_src elisp
(with-eval-after-load 'org
  (cl-defmacro lsp-org-babel-enable (lang)
    "Support LANG in org source code block."
    (cl-check-type lang stringp)
    (let* ((edit-pre (intern (format "org-babel-edit-prep:%s" lang)))
           (intern-pre (intern (format "lsp--%s" (symbol-name edit-pre)))))
      `(progn
         ;;;;;;;;;;;; always use temp file
         (defun ,intern-pre (info)
           (let ((file-name (make-temp-file "babel-lsp-")))
             (setq buffer-file-name file-name)
             (eglot-ensure)))

         ;; (lsp-deferred)))
         (put ',intern-pre 'function-documentation
              (format "Enable lsp-mode in the buffer of org source block (%s)."
                      (upcase ,lang)))
         (if (fboundp ',edit-pre)
             (advice-add ',edit-pre :after ',intern-pre)
           (progn
             (defun ,edit-pre (info)
               (,intern-pre info))
             (put ',edit-pre 'function-documentation
                  (format "Prepare local buffer environment for org source block (%s)."
                          (upcase ,lang))))))))
  (defvar org-babel-lang-list
    '("python" "C++" "C" "c" "cpp" "dot"))
  (dolist (lang org-babel-lang-list)
    (eval `(lsp-org-babel-enable ,lang)))
  )
#+end_src
*** spell-check
**** jinx
#+begin_src elisp
(setup jinx
(defun check-enchant-available ()
  "Check if enchant is available on the system."
  (executable-find "enchant-2"))

(when (check-enchant-available)
  (dolist (hook '(text-mode-hook conf-mode-hook))
    (add-hook hook #'jinx-mode)))
  (:when-loaded
    (setq jinx-languages "en_US")
    (add-to-list 'jinx-exclude-regexps '(t "\\cc"))
    (keymap-global-set "M-$" #'jinx-correct)
    (keymap-global-set "C-M-$" #'jinx-languages)))
#+end_src
*** debug
**** gdb
#+begin_src elisp
(setup gdb-mi
  (setq gdb-restore-window-configuration-after-quit t))
#+end_src
**** dape
#+begin_src elisp
(setup dape
  (setq dape-buffer-window-arrangment 'right)
  (keymap-global-set "<f5>"  #'dape)
  (:when-loaded
    (add-hook 'dape-repl-mode-hook (lambda()
                                     (corfu-mode -1)
                                     )
  )))
#+end_src
**** edebug
#+begin_src lisp
(setup edebug
  (:with-map edebug-mode-map
    (:bind "n" edebug-step-mode
           "N" edebug-next-mode
  )))
#+end_src
*** Code toggle with hideshow, hideif
#+begin_src elisp
(setup hideshow
  (:with-hook prog-mode-hook
    (:hook hs-minor-mode))
  (add-to-list 'hs-special-modes-alist '(verilog-mode "\\(\\<begin\\>\\|\\<case\\>\\|\\<module\\>\\|\\<class\\>\\|\\<function\\>\\|\\<task\\>\\)"
                                                      )))
#+end_src
*** format-all
#+begin_src elisp
(setup inheritenv)
(setup language-id)
(setup format-all)
#+end_src
*** compile
#+begin_src elisp
(setup compile
  (setq compile-command "cd build && make && ./test"))
#+end_src
* Org Mode
** org-mode
#+begin_src elisp
(setup engrave-faces) ;; for code highlight when exporting pdfs
(setup org
  (setq org-adapt-indentation nil
        org-startup-indented t
        org-startup-with-inline-images nil
        org-startup-numerated nil
        org-startup-folded nil
        org-hide-block-startup t
        org-imenu-depth 8
        org-return-follows-link t
        org-id-link-to-org-use-id t ;; Create an ID if needed to make a link to the current entry.

        org-link-frame-setup '((vm . vm-visit-folder-other-frame)
                               (vm-imap . vm-visit-imap-folder-other-frame)
                               (gnus . org-gnus-no-new-news)
                               (file . find-file)
                               (wl . wl-other-frame))
        ;; org-blank-before-new-entry '((heading . t)
        ;;                              (plain-list-item . auto))

        org-image-actual-width 800 ;; this will use 600 for width for all the images.
        org-preview-latex-image-directory (concat no-littering-var-directory "ltximg/")
        org-plantuml-jar-path plantuml-jar-path
        org-special-ctrl-a/e t
        ;; org-id
        org-attach-id-dir (concat nowis/doc-emacs-dir "01-orgmode/org-attach")
        org-id-method 'ts
        org-id-ts-format "%Y%m%dT%H%M%S_%6N"

        ;; habit
        org-habit-following-days 2
        system-time-locale "C" ;; ensure time format is always english
        ;; todo keywords
        org-todo-keyword-faces '(("TODO"    :foreground "red"    :weight bold)
                                 ("NEXT"    :foreground "deep sky blue" :weight bold)
                                 ("WAIT"    :foreground "goldenrod"     :weight bold)
                                 ("SMDY"    :foreground "medium purple" :weight bold)
                                 ("DONE"    :foreground "forest green"  :weight bold)
                                 ("AXED"    :foreground "gray55"        :weight bold))
        ;; save state changes into logbook
        org-log-state-notes-into-drawer t
        ;; plain list
        org-list-demote-modify-bullet '(("+" . "-") ("-" . "+") ("*" . "+"))
        ;; attach
        org-yank-image-save-method (concat nowis/doc-emacs-dir "30-saved-binary/01-pictures/01-org_attachs")
        )
  (:when-loaded
    (require 'org-tempo) ;; so that <s is useful
    ))
#+end_src
** org-src
#+begin_src elisp
(setup org
  (setq org-edit-src-content-indentation 0
        org-confirm-babel-evaluate nil
        ;; org-src
        org-src-window-setup 'split-window-below)
  (:when-loaded
    ;; org-src-lang-modes
    (add-to-list 'org-src-lang-modes '("dot" . graphviz-dot))
    ;; dynamic load org-src modules to accelerate speed
    (defun nowis/org-babel-execute-src-block (&optional _arg info _params)
      "Load language if needed"
      (let* ((lang (format "%s" (nth 0 info)))
             (sym (cond ((member (downcase lang) '("c" "cpp" "c++")) 'C)
                        ((member (downcase lang) '("jupyter-python")) 'jupyter)
                        (t (intern lang))))
             (backup-languages org-babel-load-languages))
        (unless (assoc sym backup-languages)
          (condition-case err
              (progn
                (org-babel-do-load-languages 'org-babel-load-languages (list (cons sym t)))
                (setq-default org-babel-load-languages (append (list (cons sym t)) backup-languages)))
            (file-missing
             (setq-default org-babel-load-languages backup-languages)
             err)))))
    (advice-add 'org-babel-execute-src-block :before #'nowis/org-babel-execute-src-block )
    ;; didn't redisplay for now
    ;; (add-hook 'org-babel-after-execute-hook 'org-redisplay-inline-images)
    (defun nowis/open-generated-image ()
      "Open the image file generated by org-babel in a new window."
      (when (org-in-src-block-p)  ; Check if inside a code block
        (let* ((info (org-babel-get-src-block-info)))  ; Get code block info
          (when info
            (let ((file (cdr (assq :file (nth 2 info)))))  ; Extract the :file parameter value
              (when (and file (file-exists-p file))  ; Check if the file exists
                (let ((buffer (find-file-noselect file)))  ; Get the buffer for the image file
                  (display-buffer buffer '(display-buffer-pop-up-window))  ; Display the buffer in a new window
                  (with-current-buffer buffer
                    (image-mode)))))))))  ; Enable image mode for the buffer
      (add-hook 'org-babel-after-execute-hook 'nowis/open-generated-image)
      ))
#+end_src
** org-ox,latex,word,markdown
#+begin_src elisp
(setup org
  ;; export without _ or ^
  (setq org-use-sub-superscripts nil)
  (setq org-export-with-sub-superscripts nil)
  (:when-loaded
    (with-eval-after-load 'ox-latex
      (setq org-latex-pdf-process '("tectonic %f")
            org-latex-default-class "scrbook"
            user-full-name "Lewis Liu"
            org-latex-default-table-environment "longtable"
            org-latex-listings 'engraved
            org-latex-image-default-option "max size={\\textwidth}{\\textheight}" ;; use adjustbox
            org-latex-image-default-width ""
            )
      ;; if you want to add svg support:
      ;;  1. install inkscape
      ;;  2. \usepackage[inkscapeversion=1]{svg}
      (add-to-list 'org-latex-classes
                   '("scrbook"
                     "\\documentclass[openany,oneside]{scrbook}
                      \\usepackage{ctex}
                      \\usepackage[export]{adjustbox}
                      \\usepackage{fancyhdr}
                      \\pagestyle{fancy}
                      \\fancyhead[L]{\\textsl{\\rightmark}}
                      \\fancyhead[R]{\\textsl{\\leftmark}}
                      \\renewcommand{\\footrulewidth}{0.4pt}"
                     ("\\part{%s}" . "\\part*{%s}")
                     ("\\chapter{%s}" . "\\chapter*{%s}")
                     ("\\section{%s}" . "\\section*{%s}")
                     ("\\subsection{%s}" . "\\subsection*{%s}")
                     ("\\subsubsection{%s}" . "\\subsubsection*{%s}")))
      )

    ;; preview latex
    (add-to-list 'org-preview-latex-process-alist
	             '(tectonic :programs ("tectonic" "convert")
			                :description "pdf > png"
			                :message "you need install the programs: tectonic and imagemagick."
			                :image-input-type "pdf"
			                :image-output-type "png"
			                :image-size-adjust (1.0 . 1.0)
			                :latex-compiler
			                ("tectonic -Z shell-escape-cwd=%o --outfmt pdf --outdir %o %f")
			                :image-converter
			                ("convert -density %D -trim -antialias %f -quality 300 %O")))
    (setq org-preview-latex-default-process 'tectonic) ;; need to install tectonic and imagemagick


    (plist-put org-format-latex-options :scale 1.0) ;; use a large preview for latex
    ;; (setq org-preview-latex-default-process 'dvisvgm)
    ;; export and open word
    (add-to-list 'org-file-apps '("\\.docx\\'" . default))
    (add-to-list 'org-structure-template-alist
                 '("jp" . "src jupyter-python :async yes :kernel python3 :session py"))

    ))
#+end_src
** org-clock
#+begin_src elisp
(setup org-clock
  (setq org-clock-mode-line-entry 'current)
  (:when-loaded
    (defun nowis/org-show-reminder ()
      "Function to show a reminder buffer."
      (let ((buf (get-buffer-create "*Org Clock Reminder*"))
            (messages
             (list
              (propertize "Finished a time-box!" 'face '(:weight bold :height 1.5))
              (propertize "Take a break and think what's most important!" 'face '(:foreground "orange" :weight semi-bold))))
            )
        (with-current-buffer buf
          (erase-buffer)
          (insert (make-string (max 0 (/ (- (frame-height) 1) 6)) ?\n)) ;; whitespace line
          (dolist (message messages)
            (insert message "\n"))
          (center-region (point-min) (point-max))
          (goto-char (point-min))
          (display-buffer buf)
          )))

    (add-hook 'org-timer-set-hook #'org-clock-in)
    (add-hook 'org-timer-done-hook #'nowis/org-show-reminder)
    (add-hook 'org-timer-done-hook #'org-clock-out)
    ))
#+end_src
** org-timer
#+begin_src elisp
(setup org-timer
  (setq org-timer-default-timer 25))
#+end_src
** appt
#+begin_src elisp :tangle no
(setup appt
  (:load-after org)
  (:when-loaded
    (run-at-time nil 3600 'org-agenda-to-appt)
    ;; 更新agenda时，同步appt
    (add-hook 'org-finalize-agenda-hook 'org-agenda-to-appt)
    ;; 激活提醒
    (appt-activate 1)
    ))
#+end_src
** ui
*** org mode basic style
#+begin_src elisp
(setup org
  (setq org-auto-align-tags nil
        org-tags-column 0
        org-ellipsis " "
        org-hide-emphasis-markers t
        org-pretty-entities nil ;; can perfor ui such as "a_words" into small "awords"
        org-habit-graph-column 50
        ;; Agenda styling
        org-agenda-tags-column 0
        )
  (:when-loaded
    ;; emphasis
    (defface my-org-emphasis-bold
      '((default :inherit bold)
        (((class color) (min-colors 88) (background light))
         :foreground "pale violet red")
        (((class color) (min-colors 88) (background dark))
         :foreground "pale violet red"))
      "My bold emphasis for Org.")

    (defface my-org-emphasis-italic
      '((default :inherit italic)
        (((class color) (min-colors 88) (background light))
         :foreground "green3")
        (((class color) (min-colors 88) (background dark))
         :foreground "green3"))
      "My italic emphasis for Org.")

    (defface my-org-emphasis-underline
      '((default :inherit underline)
        (((class color) (min-colors 88) (background light))
         :foreground "#813e00")
        (((class color) (min-colors 88) (background dark))
         :foreground "#d0bc00"))
      "My underline emphasis for Org.")

    (setq org-emphasis-alist
          '(("*" my-org-emphasis-bold)
            ("/" my-org-emphasis-italic)
            ("_" underline)
            ("=" org-verbatim verbatim)
            ("~" org-code verbatim)
            ("+" (:strike-through t))
            ))
    ))
#+end_src
*** org beatury
#+begin_src elisp
(with-eval-after-load 'org
  (setq org-hide-leading-stars t)
  (let ((star-list '("󰯬" "󰯯" "󰯲" "󰯵" "󰯸" "󰯻" "󰯾" "󰰁" "󰰄" "󰰇" "󰰊")))
    (dotimes (i (length star-list))
      (font-lock-add-keywords
       'org-mode
       `((,(format "^\\(\\*\\{%d\\}\\) " (+ i 1)) ;; 只捕获星号
          (1 (prog1 nil   ;; 1 是第一个 group（星号）
               (compose-region (match-beginning 1) (match-end 1)
                               ,(nth i star-list))))))))
    ))
;; ┌───────────────┐
;; │ prettify-mode │
;; └───────────────┘

(defun my/org-prettify-compose-p (start end match)
  "Custom compose predicate for org-mode.
Always allow composition for org-mode keywords, regardless of context."
  (cond
   ((string-prefix-p "#+" match) t)
   ((string-prefix-p ":" match) t)
   (t (prettify-symbols-default-compose-p start end match))))


(add-hook 'org-mode-hook (lambda()
                           (setq prettify-symbols-alist
                                 '(("#+begin_src" . ?)
                                   ("#+end_src" . ?)
                                   ("#+BEGIN_SRC" . ?)
                                   ("#+END_SRC" . ?)
                                   ("#+begin_tool" . ?󱁤)
                                   ("#+end_tool" . ?)
                                   ("#+begin_quote" . ?󱀢)
                                   ("#+end_quote" . ?)
                                   (":PROPERTIES:" . ?)
                                   (":SRSITEMS:" . ?)
                                   (":LOGBOOK:" . ?)
                                   (":END:" . ?)
                                   ))
                           (setq prettify-symbols-compose-predicate #'my/org-prettify-compose-p)
                           (prettify-symbols-mode)
                           ))
#+end_src
*** org-appear
#+begin_src elisp
(setup org-appear
  (:hook-into org-mode))
#+end_src
*** org-visual-outline
#+begin_src elisp
(setup org-visual-outline
  (add-hook 'org-mode-hook #'org-visual-indent-mode))
#+end_src
** ox-hugo
#+begin_src elisp
(setup tomelr)
(setup ox-hugo
  (setq org-hugo-section "posts")
  (with-eval-after-load 'ox
    (require 'ox-hugo)))
#+end_src
** org-present
#+begin_src elisp
(setup org-present)
#+end_src
** bibtex related
*** bibtex
#+begin_src elisp
(setup bibtex
  (setq bibtex-autokey-year-length 4
        bibtex-autokey-titleword-separator "_"
        bibtex-autokey-name-year-separator "_"
        bibtex-autokey-year-title-separator "_"
        bibtex-autokey-titleword-length 15
        bibtex-autokey-titlewords 10
        bibtex-autokey-titleword-ignore ;; I took "On" out of this
        '("A" "An" "The" "Eine?" "Der" "Die" "Das")
        bibtex-dialect 'biblatex
        )
  (with-eval-after-load 'bibtex
    (add-to-list 'bibtex-biblatex-field-alist
                 '("keywords" "Keywords or phrases")))

  )

(defun do.refs/get-db-file-list ()
  "Get the list of all the bib files containing my bib database."
  (if (file-exists-p nowis/bib-dir)
      (directory-files-recursively nowis/bib-dir "\\.bib\\'" t)
    nil))
#+end_src
*** parse-bibtex-into-denote
#+begin_src elisp
(defun denote-bibtex-update-reference ()
  (interactive)
  (save-excursion
    (goto-char (point-min))
    (when (re-search-forward "^#\\+begin_src bibtex\n@\\w+{\\([^,]+\\)" nil t)
      (let ((key (match-string 1)))
        (goto-char (point-min))
        (if (re-search-forward "^#\\+title:" nil t)
            (progn
              (beginning-of-line)
              (kill-line)
              (insert (format "#+title:      %s" key))))
        (if (re-search-forward "^#\\+reference:" nil t)
            (progn
              (beginning-of-line)
              (kill-line)
              (insert (format "#+reference:  %s" key)))
          (goto-char (point-min))
          (when (re-search-forward "^#\\+identifier:" nil t)
            (end-of-line)
            (insert (format "\n#+reference:  %s" key))))
        (message "已更新 reference: %s" key)
        ;; use denote to rename current file
        (denote-rename-file-using-front-matter (buffer-file-name))
        ))))
#+end_src

*** citar
#+begin_src elisp
(setup parsebib)
;; (setup citeproc) ;;<- (setup queue) (setup string-inflection)
(setup citar
  (setq org-cite-global-bibliography (do.refs/get-db-file-list)
           org-cite-insert-processor 'citar
           org-cite-follow-processor 'citar
           org-cite-activate-processor 'citar
           citar-library-paths (list nowis/bib-pdf-dir)
           citar-bibliography org-cite-global-bibliography
           ;; org-cite-export-processors '((t . (csl "modern-language-association.csl")))
           ))
#+end_src
*** citar-denote
#+begin_src elisp
(setup citar-denote
  (setq citar-denote-title-format "author-year-title")
  (with-eval-after-load 'citar
    (citar-denote-mode)
    )
  )
#+end_src
*** ebib
#+begin_src elisp
(setup ebib
  (setq ebib-preload-bib-files org-cite-global-bibliography
           ebib-file-search-dirs (list nowis/bib-pdf-dir)
           ebib-bib-search-dirs (list nowis/bib-dir)
           ebib-default-directory 'first-bib-dir
           ebib-file-associations '(("pdf")
                                    ("ps" . "gv")
                                    ("epub"))
           ebib-index-window-size 25
           ebib-index-columns '(("Score" 2 t)
                                ("Year" 6 t)
                                ("Author/Editor" 10 t)
                                ("Title" 80 t)
                                ("abstract" 10 t)
                                )
           ebib-reading-list-file (concat nowis/doc-emacs-dir "01-orgmode/xnotes/20230403T125743--ebib-reading-lists.org")
           ebib-use-timestamp t
           ebib-bibtex-dialect 'biblatex
           ebib-create-backups nil
           ))
#+end_src
** denote and related
*** denote
#+begin_src elisp
(setup denote
  (setq denote-directory (expand-file-name (concat nowis/doc-emacs-dir "01-orgmode/xnotes"))
        ;; denote-dired-directories (ffap-all-subdirs denote-directory)
        denote-date-prompt-use-org-read-date t
        denote-modules '(project)
        denote-prompts '(title keywords signature template)
        denote-dired-directories-include-subdirectories t
        )
  ;; (add-hook 'dired-mode-hook #'denote-dired-mode-in-directories)
  (setq denote-templates
        `((journal . ,(concat "* A\n"
                              "* B\n"
                              "* C\n"))
          (bib . ,(concat "#+begin_src bibtex\n"
                           "#+end_src\n"
                           "* notes"))
          (have_or_want . ,(concat "* 我有的\n"
                           "* 我要的"))
          (gtd . ,(concat "* Important\n\n"
                          "* Diary\n\n"))
          ))
  )
#+end_src
*** denote-sort
#+begin_src elisp
(defun my-denote--split-luhman-sig (signature)
  "Split numbers and letters in Luhmann-style SIGNATURE string."
  (replace-regexp-in-string
   "\\([a-zA-Z]?\\)\\([0-9]\\)" "\\1=\\2"
   (replace-regexp-in-string
    "\\([0-9]?\\)\\([a-zA-Z]\\)" "\\1=\\2"
    signature)))

(defun my-denote--pad-sig (signature)
  "Create a new signature with padded spaces for all components"
  (combine-and-quote-strings
   (mapcar
    (lambda (x)
      (string-pad x 5 32 t))
    (split-string (my-denote--split-luhman-sig signature) "=" t))
   "="))

(defun my-denote-sort-for-signatures (sig1 sig2)
  "Return non-nil if SIG1 is smaller that SIG2.
Perform the comparison with `string<'."
  (string< (my-denote--pad-sig sig1) (my-denote--pad-sig sig2)))
;; Change the sorting function only when we sort by signature.
(setq denote-sort-signature-comparison-function #'my-denote-sort-for-signatures)
#+end_src
*** denote-journal
#+begin_src elisp
(setup denote-journal
  (setq denote-journal-title-format "%Y_%m_%d_%a_%j")
  (add-hook 'calendar-mode-hook #'denote-journal-calendar-mode)
  )
#+end_src
*** denote-explorer
#+begin_src elisp
(setup denote-explore)
#+end_src
** find orgmode dir files
#+begin_src elisp
(defun project-find-searchable-dir-files ()
  (interactive)
  (dired (concat nowis/doc-emacs-dir "02-binary-git/searchable"))
  (project-find-file t))
(defun project-find-gtd-dir-files ()
  (interactive)
  (dired nowis/gtd-dir)
  (project-find-file t))
#+end_src
** agenda/gtd
Borrowed from https://github.com/rougier/emacs-GTD

In short, you will need 3 files:
1. =index.org= for capture inbox TODOs
2. =agenda.org= for recurrent events
3. =action.org= for all tasks moving from inbox
4. (Option) =incubate.org= for incubate ideas
*** file
#+begin_src elisp
;; Files
(setq org-directory "~/Documents/emacs/01-orgmode/xnotes")

(setup org
  (:when-loaded
    (defun org-agenda-update-agenda-files ()
      "Update agenda file list together with refile list."
      (interactive)
      (let* ((gtd-dir (concat org-directory "/gtd"))
             (gtd-files (when (file-exists-p gtd-dir)
                          (directory-files-recursively gtd-dir "\\.org$")))
             )
        (setq org-agenda-files gtd-files)

      (setq org-refile-files
            (cl-remove-if (lambda (file) (string-match-p "inbox.org$" file))
                          org-agenda-files))
      (add-to-list 'org-refile-files (expand-file-name (concat org-directory "/org-inc/20251201T112101--incubate.org")))
      ))
    (org-agenda-update-agenda-files)
    ))

#+end_src
*** todos
#+begin_src elisp
(setq org-enforce-todo-dependencies t
      org-enforce-todo-checkbox-dependencies t
      )
(setq org-log-done 'note)
(setq org-todo-keywords
      '((sequence "TODO(t)" "NEXT(n)" "WAIT(w)" "SMDY(s)" "|" "AXED(a)" "DONE(d)")))

(defun log-todo-next-creation-date (&rest ignore)
  "Log NEXT creation time in the property drawer under the key 'ACTIVATED'"
  (when (and (string= (org-get-todo-state) "NEXT")
             (not (org-entry-get nil "ACTIVATED")))
    (org-entry-put nil "ACTIVATED" (format-time-string "[%Y-%m-%d]"))))
(add-hook 'org-after-todo-state-change-hook #'log-todo-next-creation-date)
(setq org-priority-lowest 69) ;; E
(setq org-priority-default 68) ;; D

#+end_src
*** capture
#+begin_src elisp
;; Use full window for org-capture
;; (add-hook 'org-capture-mode-hook 'delete-other-windows)
(setup org
  (:when-loaded
    (defvar nowis/org-inc-topic-capture-file-path
      (concat org-inc-directory "20251201T112101--incubate.org")
      "topic capture file")

    (defun nowis/org-inc-topic-capture-file ()
      "Return the target file for topic capture.
If there is a prefix argument, prompt the user to select a file and save it for future use;
otherwise use the saved file."
      (if current-prefix-arg
          (let ((selected-file
                 (read-file-name "Choose target topic capture file: "
                                 org-inc-directory
                                 nil
                                 t
                                 nil
                                 (lambda (name)
                                   (string-match-p "\\.org$" name)))))
            (setq nowis/org-inc-topic-capture-file-path selected-file)
            (message "topic capture file is set to: %s" selected-file)
            selected-file)
        nowis/org-inc-topic-capture-file-path))

    (setq org-capture-templates
          `(
            ("i" "Inbox" entry  (file "gtd/inbox.org")
             ,(concat "* TODO [#C] %?\n"
                      ":PROPERTIES:\n:CREATED: %U\n:END:\n")
             )
            ("d" "Done without clock" entry (file+olp+datetree "gtd/inbox.org")
             ,(concat "* DONE %?\n"
                      "CLOSED: %U"))
            ("t" "org-inc topic" entry (file nowis/org-inc-topic-capture-file)
             ,(concat "** topic card\n" ":PROPERTIES:\n:CREATED: %U\n:END:\n%?")
             :before-finalize ,(lambda ()
                                 (if (not (featurep 'org-inc))
                                     (require 'org-inc))
                                 (unless (org-id-get)
                                   (org-id-get-create))
                                 (org-srs-item-new 'topic)))
            )))
  (defun org-inc-topic-capture-from-clipboard (&optional arg)
    "Create a topic capture from clipboard contents.
If region is active, use region text instead.
When called with prefix argument, prompt to select target file."
    (interactive "P")
  (let* ((current-prefix-arg arg)
         (content (if (use-region-p)
                      (buffer-substring-no-properties
                       (region-beginning) (region-end))
                    (or (and (fboundp 'gui-get-selection)
                             (gui-get-selection 'CLIPBOARD 'STRING))
                        (current-kill 0 t)   ;; t: 不报错，空则 nil
                        ""))))
    (org-capture nil "t")
      (insert content)))
  )
#+end_src
*** refile
#+begin_src elisp
(setup org
  (:when-loaded
    (setq org-refile-use-outline-path t)
    (setq org-outline-path-complete-in-steps nil)
    (setq org-refile-targets
          '((org-refile-files :level 1)))
    ;; Save the corresponding buffers
    (defun gtd-save-org-buffers ()
      "Save `org-agenda-files' buffers without user confirmation.
See also `org-save-all-org-buffers'"
      (interactive)
      (message "Saving org-agenda-files buffers...")
      (save-some-buffers t (lambda ()
                             (when (member (buffer-file-name) org-agenda-files)
                               t)))
      (message "Saving org-agenda-files buffers... done"))

    ;; Add it after refile
    (advice-add 'org-refile :after
                (lambda (&rest _)
                  (gtd-save-org-buffers)))

    ))
#+end_src
*** agenda
#+begin_src elisp
(defun org-get-parent-heading ()
  (save-excursion
    (when (org-up-heading-safe)
      (let ((parent (org-get-heading 'no-tags 'no-todo 'no-priority 'no-comment)))
        (truncate-string-to-width parent 20 nil ?\s)))))
(defun nowis/align-to-window-center(text)
  (let* ((title text)
         (width (window-width (get-buffer-window)))
         (pad (/ (1+ (- width (string-width title))) 2)))
    (concat (make-string (max 0 pad) ? ) title)))

(defvar nowis/agenda-prefix-format-enhanced
  "[%-4e] :"
  "Enhanced agenda prefix format.")

(defun my/agenda-sort-by-parent (a b)
  "Sort agenda items by parent heading."
  (let ((ha (org-with-point-at (get-text-property 0 'org-marker a)
              (or (org-get-parent-heading) "")))
        (hb (org-with-point-at (get-text-property 0 'org-marker b)
              (or (org-get-parent-heading) ""))))
    (cond
     ((string< ha hb) 1)
     ((string< hb ha) 1)
     (t 0))))

(setq org-agenda-cmp-user-defined #'my/agenda-sort-by-parent)

(setq org-agenda-prefix-format
      '((agenda . " %i %-12:c%?-12t% s[%-4e]") (todo . "[%-4e]: ") (tags . "[%-4e]: ")
        (search . " %i %-12:c")))

(defun my/agenda-add-parent-separators ()
  "Add separator lines between different parent groups, depends on sorted by parent."
  (save-excursion
    (goto-char (point-min))
    (let (last-parent)
      (while (not (eobp))
        (let ((marker (get-text-property (point) 'org-marker)))
          (when marker
            (let ((parent (org-with-point-at marker
                            (or (org-get-parent-heading) ""))))
              (when (not (string= parent (or last-parent "")))
                (let ((inhibit-read-only t))
                  (insert (propertize
                           (concat " " parent "\n")
                           'face 'org-agenda-structure)))
                (setq last-parent parent)))))
        (forward-line)))))

(add-hook 'org-agenda-finalize-hook 'my/agenda-add-parent-separators)

(defmacro nowis/create-agenda-command (key description tag)
  `(list ,key ,description
         '(
           (agenda ""
                   ((org-agenda-overriding-header (nowis/align-to-window-center " Today's Target "))
                    (org-agenda-span 'day)
                    (org-agenda-skip-function
                     '(org-agenda-skip-if nil '(todo done)))))
           (tags-todo "action+next"
                      ((org-agenda-overriding-header (nowis/align-to-window-center "One-Step Action"))
                       (org-agenda-skip-function '(org-agenda-skip-entry-if 'scheduled))
                       (org-agenda-sorting-strategy '(todo-state-up priority-down timestamp-up))
                       ))
           (tags-todo "action+project"
                      ((org-agenda-overriding-header (nowis/align-to-window-center "Multi-Steps Action"))
                       (org-agenda-skip-function '(org-agenda-skip-entry-if 'scheduled))
                       (org-agenda-sorting-strategy '(user-defined-up todo-state-up priority-down timestamp-up))
                       ))
           (tags-todo "inbox"
                      ((org-agenda-overriding-header (nowis/align-to-window-center "Inbox"))
                       (org-agenda-sorting-strategy '(todo-state-up priority-down timestamp-up))
                       ))
           (tags ,(concat "CLOSED>=\"<today>\"" tag)
                 ((org-agenda-overriding-header (nowis/align-to-window-center "Completed today"))
                  (org-agenda-sorting-strategy '(tsia-down))
                  ))
           (tags ,(concat "CLOSED>=\"<-1w>\"" tag)
                 ((org-agenda-overriding-header (nowis/align-to-window-center "Completed last 7 days"))
                  (org-agenda-sorting-strategy '(tsia-down))
                  ))
           )))

(setq org-agenda-custom-commands
      (list (nowis/create-agenda-command "g" "GTD" "")
            (nowis/create-agenda-command "w" "Work" "+work")
            ))
;; agenda clockreport
(setq org-agenda-start-with-clockreport-mode nil
      org-agenda-clockreport-parameter-plist '(:link t :maxlevel 5 :properties ("Effort"))
      org-clock-out-remove-zero-time-clocks t)
;; agenda style
(setq org-agenda-hide-tags-regexp "\\(inbox\\|action\\|journal\\|project\\|next\\)")
#+end_src
*** archive
#+begin_src elisp
(defun nowis/get-closed-time-or-current-time ()
  "Get the CLOSED time of the current subtree or use the current time if not available."
  (let ((closed-time (org-entry-get (point) "CLOSED")))
    (if closed-time
        (org-time-string-to-time closed-time)
      (current-time))))

(defun nowis/org-archive-subtree ()
  "Archive the current subtree to a corresponding archive file based on the task's completion date."
  (interactive)
  (let* ((current-file (buffer-file-name))
         (completed-time (nowis/get-closed-time-or-current-time))
         (archive-file (concat "gtd_archive_" (format-time-string "%Y" completed-time)
                               "::datetree/")))
    (setq org-archive-location archive-file)
    (org-archive-subtree)))

#+end_src
** org-srs
#+begin_src elisp
(setup lisp-fsrs)
(setup org-srs
  (add-hook 'org-mode-hook #'org-cloze-overlay-mode)

 (defun org-cloze-fontify (limit)
  "Fontify cloze markup up to LIMIT."
  (let (found)
    (while (re-search-forward "{{\\([0-9a-z]+\\)}{\\([^}]+\\)}}" limit t)
      (add-text-properties (match-beginning 0) (match-beginning 2) '(invisible t))
      (add-text-properties (match-beginning 2) (match-end 2) '(face (:foreground "gold1")))
      (add-text-properties (match-end 2) (match-end 0) '(invisible t))
      (setq found t))
    found))
 (define-minor-mode org-cloze-overlay-mode
  "Toggle org-cloze-overlay-mode."
  :lighter " Cloze"
  (if org-cloze-overlay-mode
      (progn
        (font-lock-add-keywords nil '((org-cloze-fontify . 0)) t)
        (font-lock-flush))
    (font-lock-remove-keywords nil '((org-cloze-fontify . 0)))
    (font-lock-flush)))

 (:when-loaded
   ;; (org-srs-ui-mode +1)
   )
  )
#+end_src
** org-inc
#+begin_src elisp
(setup org-inc
  (:autoload org-inc-continue)
  (:autoload org-inc-create)
  (defun nowis/org-inc-continue-interactive ()
    "Call org-inc-continue interactively."
    (interactive)
    (call-interactively 'org-inc-continue))

  (transient-define-prefix org-srs-transient-map()
    "Define transient-key map for org-fc functions"
    [
     ["review"
      ("r" "continue" nowis/org-inc-continue-interactive :transient t)
      ("c" "create" org-inc-create)
      ("a" "abort" org-inc-abort)
      ("d" "dismiss" org-inc-dismiss)
      ("p" "Priority" org-inc-priority)
      ("P" "postpone" org-inc-postpone)
      ]
     ["rate"
      ("1" "easy" org-srs-review-rate-easy :transient t)
      ("2" "good" org-srs-review-rate-good :transient t)
      ("3" "hard" org-srs-review-rate-hard :transient t)
      ("4" "again" org-srs-review-rate-again :transient t)
      ]])

  (setq org-inc-directory (expand-file-name "org-inc/" org-directory)
        org-srs-item-confirm #'org-srs-item-confirm-command)
  (:with-map org-mode-map
    (:bind "C-M-<return>" org-inc-continue
           "<f4>" org-inc-continue
           ))
  (:when-loaded
    (add-hook 'org-mode-hook #'org-inc-overlay-mode)

    (nowis/smart-bind "M-z" #'region-active-p #'org-inc-extract)
    (nowis/smart-bind "M-c" #'region-active-p #'org-srs-item-cloze-dwim)
    )
  )
    #+end_src
** nowis-read-mode
#+begin_src elisp
(defgroup nowis-read nil
  "nowis-read minor mode."
  :group 'convenience
  :prefix "nowis-read-")

(defvar nowis-read-mode-map
  (let ((map (make-sparse-keymap)))
    (define-key map (kbd "M-z") #'nowis-capture-inc)
    map)
  "Keymap for `nowis-read-mode'.
Keys defined here will override existing bindings when the mode is active.")

(defun nowis-capture-inc ()
  (interactive)
      (progn
        (execute-kbd-macro (kbd "M-w"))
        (sit-for 0.1))
  (org-inc-topic-capture-from-clipboard))

(define-minor-mode nowis-read-mode
  "Minor mode that overrides key bindings in the current buffer."
  :lighter nil  ; No mode-line indicator
  :keymap nowis-read-mode-map
  :group 'nowis-read)
#+end_src
** insert from clipboard
#+begin_src elisp
(setup org
  (:when-loaded
    (defcustom nowis/org-yank-image-filename-function
      (lambda () (format-time-string "screenshot_%Y%m%d_%H%M%S.png"))
      "A function to generate screenshot name"
      :type 'function
      :group 'org)

    (defun nowis/org-yank-image-from-clipboard-wsl ()
      "paste from wsl"
      ;; (interactive)
      (require 'org-attach)
      (let* ((attach-dir (org-attach-dir t))
             (filename (funcall nowis/org-yank-image-filename-function))
             (filepath (expand-file-name filename attach-dir))
             (wsl-path (string-trim
                        (shell-command-to-string
                         (format "wslpath -w '%s'" filepath)))))
        (if (= 0 (call-process "powershell.exe" nil nil nil
                               "-Command"
                               (format "(Get-Clipboard -Format image).Save('%s')" wsl-path)))
            (progn
              (insert (format "[[attachment:%s]]" filename))
              (org-display-inline-images)
              (message "Image saved to attachment: %s" filepath))
          (error "Failed to save image from clipboard"))))

    (defun nowis/org-yank-image-from-clipboard-native ()
      "use the default yank-media"
      (yank-media))

    (defun nowis/org-yank-image-from-clipboard ()
      "paste pictures from powershell when using wsl, others use yank-media"
      (interactive)
      (if (string= "Arch" (getenv "WSL_DISTRO_NAME"))
          (nowis/org-yank-image-from-clipboard-wsl)
        (nowis/org-yank-image-from-clipboard-native)))
    (:with-map org-mode-map
      (:bind "M-<f1>" nowis/org-yank-image-from-clipboard)
      )
    ))
#+end_src
** org-sliced-images
#+begin_src elisp
(setup org-sliced-images
  (:hook-into org-mode)
  )
#+end_src
** org-ladder
#+begin_src elisp
(setup org-ladder
  (let* ((gtd-dir (expand-file-name "gtd" org-directory))
         (gtd-files (when (file-directory-p gtd-dir)
                      (directory-files-recursively gtd-dir ".*"))))
    (setq org-ladder-files gtd-files))
  )
#+end_src
* 阅读
** reader
#+begin_src elisp
(setup reader)
#+end_src
** newsticker
#+begin_src elisp
(setq newsticker-url-list '(("Planet Emacslife" "https://planet.emacslife.com/atom.xml")
                            ("sachachua" "https://sachachua.com/blog/feed/")
                            ("karthinks" "https://karthinks.com/index.xml")
                            ("protesilaos" "https://protesilaos.com/codelog.xml")
                            ("lazycat" "https://manateelazycat.github.io/feed.xml")
                            ("zhihu" "https://plink.anyfeeder.com/zhihu/daily")
                            ))
#+end_src
** nov
#+begin_src elisp
(setup esxml)
(setup nov
  (:bind "]" nov-scroll-up
         "[" nov-scroll-down))
(add-to-list 'auto-mode-alist '("\\.epub\\'" . nov-mode))
#+end_src
** darkroom
Simple distraction-free editing. I use darkroom instead of writeroom because it's more simple
#+begin_src elisp
(setup darkroom)
#+end_src
** markdown-mode
#+begin_src elisp
(setup markdown-mode
  (:match-file "\\.md\\'")
  (custom-set-faces
   '(markdown-header-face-1 ((t (:inherit org-level-2)))))
  )
#+end_src
* tools
** ai related
*** gptel
#+begin_src elisp
(setup gptel
  (setq gptel-default-mode 'org-mode
        ;; gptel-crowdsourced-prompts-file (concat nowis/doc-emacs-dir "09-scripts/chatgpt.csv")
        gptel-highlight-methods '(face)
        gptel-model 'claude-sonnet-4.6
        ;; gptel-max-tokens
        )
  (keymap-global-set "M-p" #'gptel-send)
  (keymap-global-set "M-r" #'gptel-rewrite)
  (keymap-global-set "M-P" #'gptel)
  (keymap-global-set "C-M-p" #'gptel-abort)
  (:hook gptel-highlight-mode)
  (:when-loaded
    (setq-default gptel-backend
                  (gptel-make-openai "momenta"
                    :host "llm-gateway.momenta.works"
                    :key 'gptel-api-key
                    :stream t
                    :models '(claude-sonnet-4.6 claude-haiku-4.5 minimax-m2.1 gpt-5.2 gemini-3-pro qwen3-coder-plus deepseek-v3.2)))
    (gptel-make-openai "chatanywhere"
      :host "api.chatanywhere.tech"
      ;; :header (lambda () `(("Authorization" . ,(concat "Bearer " (gptel--get-api-key)))))
      :key 'gptel-api-key
      :stream t
      :models '(minimax-m2.5 claude-opus-4-6 claude-haiku-4-5-20251001))
    (gptel-make-gemini "Gemini" :key 'gptel-api-key :stream t)
    (gptel-make-anthropic "DeepSeek"
      :host "api.deepseek.com/anthropic"
      :key 'gptel-api-key
      :stream t
      :models '(deepseek-chat deepseek-reasoner)
      )
    (gptel-make-gh-copilot "Copilot")

    (custom-set-faces
     '(gptel-response-highlight ((((background dark) (min-colors 88)) :background "gray22" :extend t))))
    ;; ┌─────┐
    ;; │ mcp │
    ;; └─────┘
    (require 'gptel-integrations)
    (require 'mcp)

    ;; ┌──────────┐
    ;; │ autosave │
    ;; └──────────┘

    (defvar nowis/gpt-save-directory
      "~/.emacs.d/gpt-saves/"
      "Directory for auto-saving GPT buffers")

    (defun nowis/gpt-save-on-kill-buffer ()
      (when (and (bound-and-true-p gptel-mode)
                 (buffer-modified-p))
        (if buffer-file-name
            (save-buffer)
          (let* ((ts   (format-time-string "%Y%m%dT%H%M%S"))
                 (dir  (file-name-as-directory nowis/gpt-save-directory))
                 (fn   (expand-file-name (format "gpt-%s.org" ts) dir)))
            (unless (file-directory-p dir)
              (make-directory dir t))
            (write-file fn)))))

    (add-hook 'gptel-mode-hook
              (lambda ()
                (add-hook 'kill-buffer-hook
                          #'nowis/gpt-save-on-kill-buffer
                          nil  ; append
                          t))) ; make buffer-local
    ;; ┌─────────┐
    ;; │ presets │
    ;; └─────────┘

    (defun nowis/gptel-windows-on-frame ()
      "Return all windows on frame that aren't gptel chat buffers."
      (delq (and-let* ((current-buf (window-buffer (selected-window)))
                       ((buffer-local-value 'gptel-mode current-buf)))
              (selected-window))
            (window-list)))

    (gptel-make-preset 'visible-buffers
      :description "Include the full text of all buffers visible in the frame."
      :context
      '(:eval (mapcar #'window-buffer (nowis/gptel-windows-on-frame))))

    (gptel-make-preset 'summary
     :description "summary current content"
     :system "总结所有内容, 只输出一个简短的标题, 没有任何其他内容"
      )

    (gptel-make-preset 'visible-text
      :description "Include visible text from all windows in the frame."
      :context
      '(:eval (mapcar (lambda (win) ;; Create (<buffer> :bounds ((start . end)))
                        `(,(window-buffer win)
                          :bounds ((,(window-start win) . ,(window-end win)))))
                      (nowis/gptel-windows-on-frame))))

    )
  )
#+end_src
*** gptel-agent
#+begin_src elisp
(setup gptel-agent
  (:when-loaded
    (let ((preset-dir (concat nowis/doc-emacs-dir "131-gptel-presets/")))
      (when (file-directory-p preset-dir)
        (add-to-list 'gptel-agent-dirs preset-dir)))

    (mapc (lambda (agent)
            (let ((agent-name (car agent)))
              (unless (member agent-name '("gptel-agent" "gptel-plan"))
                (apply #'gptel-make-preset agent))))
          (gptel-agent-update))

    ;; customize dangerous commands
    (eval-when-compile
      (require 'cl-lib)
      (require 'gptel-request))

    (defcustom gptel-bash-dangerous-commands
      '("rm" "rmdir" "mv" "dd" "mkfs" "fdisk" "parted"
        "chmod" "chown" "chgrp"
        "sudo" "su"
        "kill" "killall" "pkill"
        "systemctl" "service" "reboot" "shutdown" "halt" "poweroff"
        "iptables" "ufw" "firewall-cmd"
        "apt" "apt-get" "yum" "dnf" "pacman" "brew"
        "curl" "wget" "git" "svn" "mktemp")
      "List of dangerous Bash commands that require user confirmation."
      :type '(repeat string)
      :group 'gptel)

    (defun gptel-bash-extract-main-command (command)
      "Extract the main command name from COMMAND (ignoring arguments, pipes, redirections, etc.)."
      (when (and command (stringp command) (not (string-empty-p command)))
        (let* ((cmd (string-trim command))
               (cmd (replace-regexp-in-string "#.*$" "" cmd))
               (cmd (car (split-string cmd "[|;&<>]\\|&&\\|||" t "[ \t\n]+")))
               (words (split-string cmd nil t)))
          (when words
            (file-name-nondirectory (car words))))))

    (defun gptel-bash-confirm-filter (command)
      "Check if COMMAND requires confirmation (i.e., is dangerous)."
      (when-let ((main-cmd (gptel-bash-extract-main-command command)))
        (member main-cmd gptel-bash-dangerous-commands)))

   (defun gptel-bash-apply-filter ()
      "将 Bash 命令过滤器应用到 gptel-agent 的 Bash tool。"
      (interactive)
      (if-let* ((bash-tool (gptel-get-tool "Bash")))
          (progn
            (setf (gptel-tool-confirm bash-tool) #'gptel-bash-confirm-filter)
            (message "✓ Applied smart confirmation filter to Bash tool"))
        (user-error "Bash tool not found. Make sure gptel-agent-tools is loaded")))
    (gptel-bash-apply-filter)
    )
  (defun gptel-simple-agent ()
    "Start a `gptel-simple-agent' session."
    (interactive)
    (require 'gptel-agent)
    (gptel-agent default-directory "gptel-simple-agent"))

  )
#+end_src
*** gptel-local-org-prompts
#+begin_src elisp
(setup gptel-local-org-prompts
  (keymap-global-set "M-L" #'gptel-choose-org-prompt)
  (setq gptel-local-org-prompts-directory (expand-file-name "13-gptel-prompts/" nowis/doc-emacs-dir)
        gptel-local-org-prompts-preview-length 100)
  )
#+end_src
*** gptel-quick-with-prompt
#+begin_src elisp
(setup gptel-quick-with-prompt
  (:autoload gptel-quick-with-prompt)
  (keymap-global-set "M-l" #'gptel-quick-with-prompt)
  (with-eval-after-load 'embark
    (keymap-set embark-general-map "?" #'gptel-quick-with-prompt))
  )
#+end_src
*** mcp
#+begin_src elisp
(setup mcp
  (setq mcp-hub-servers
        '(("drawio" . (:command "npx"
                                :args ("@next-ai-drawio/mcp-server@latest")))
        ))
  )
#+end_src

*** whisper
#+begin_src elisp
(setup whisper
  (setq whisper-language "auto"
        whisper-model "base"
        whisper-quantize nil
        whisper-translate nil
        whisper-use-threads (- (num-processors) 1)
        whisper--ffmpeg-input-device "default"
        whisper--ffmpeg-input-format "pulse")
  )
#+end_src
*** pi-coding-agent
#+begin_src elisp
(setup pi-coding-agent
  (defalias 'pi 'pi-coding-agent)
  (setq transient-version "0.12.0")
  (setq pi-coding-agent-tool-preview-lines 1
        pi-coding-agent-bash-preview-lines 1))
#+end_src
*** agent-shell
#+begin_src elisp
(setup acp)
(setup shell-maker)
(setup agent-shell)
(setup ageht-shell-manager)
#+end_src

** webjump
#+begin_src elisp
(setup webjump
  (setq webjump-sites '(
                        ("Google" .
                         [simple-query "www.google.com"
                                       "www.google.com/search?q=" ""])
                        ("DouBan DuShu" .
                         [simple-query "book.douban.com"
                                       "search.douban.com/book/subject_search?search_text=" ""])
                        ("Github" .
                         [simple-query "github.com"
                                       "github.com/search?ref=simplesearch&q=" ""])
                        ("Aur" .
                         [simple-query "aur.archlinux.org"
                                       "aur.archlinux.org/packages?O=0&K=" ""])
                        ("leetcode-cn" .
                         [simple-query "leetcode.cn"
                                       "leetcode.cn/search/?q=" ""])
                        ("cppinfo" .
                         [simple-query "book.cppinfo.cn"
                                       "book.cppinfo.cn/so/home/qhsearch?q=" ""])
                        )))
#+end_src
** server
#+begin_src elisp
(setup server
   (progn
     (require 'server)
     (unless (server-running-p)
       (server-start))
   ))
#+end_src
** macos-ocr
#+begin_src elisp
(defun nowis/siri-ocr ()
    (interactive)
    (shell-command "shortcuts run \"OCR Selected Area\"")
    (do-applescript "tell application id \"org.gnu.Emacs\" to activate")
  )
(keymap-global-set "C-c M-o" #'nowis/siri-ocr)
#+end_src
** esup
ESUP - Emacs Start Up Profiler
#+begin_src elisp
(setup esup
  (setq esup-depth 0))
#+end_src
** uniline
#+begin_src elisp
(setup uniline)
(setup uniline-transient
  (:autoload uniline-mode)
  (:autoload uniline-launch-interface)
  (:when-loaded
    (dolist (binding '(("h" . "<left>")
                       ("j" . "<down>")
                       ("k" . "<up>")
                       ("l" . "<right>")))
      (define-key meow-normal-state-keymap
                  (kbd (car binding))
                  (kbd (cdr binding))))
    (define-key uniline-mode-map (kbd "M-i") #'uniline-launch-interface)
    )
  )
#+end_src
** manage-web-bookmarks
#+begin_src elisp
(setq org-bookmarks-file (concat nowis/doc-emacs-dir "01-orgmode/xnotes/20250731T173729--bookmarks.org"))
(defun nowis/add-bookmark ()
  "add bookmark for url into org files"
  (interactive)
  (let ((url (read-string "URL: "))
        (title (read-string "TiTle: "))
        (timestamp (format-time-string "[%Y-%m-%d %a %H:%M]")))
    (with-current-buffer (find-file-noselect org-bookmarks-file)
      (goto-char (point-max))
      (insert (format "\n* %s\n[[%s]]\n  added: %s\n" title url timestamp))
      (save-buffer))))

(defun nowis/consult-org-bookmarks ()
  "A bookmark browser based on consult-org-heading, will return to origin place after opening url"
  (interactive)
  (let ((original-buffer (current-buffer))
        (original-point (point)))
    (find-file org-bookmarks-file)
    (condition-case err
        (progn
          (consult-org-heading)
          (let ((url (save-excursion
                       (forward-line 1)
                       (when (looking-at "\\[\\[\\([^]]+\\)\\]\\]")
                         (match-string 1)))))
            (when url
              (if (not (featurep 'embark))
                  (require 'embark))
                (embark-open-externally url)))
            (switch-to-buffer original-buffer)
            (goto-char original-point))
          (quit
           (switch-to-buffer original-buffer)
           (goto-char original-point))
          (error
           (switch-to-buffer original-buffer)
           (goto-char original-point)
           (signal (car err) (cdr err))))))
#+end_src
** eww
#+begin_src elisp
(setup eww
  ;; (setq eww-search-prefix "https://www.bing.com/search?q=")
)
#+end_src
** life-calendar
#+begin_src elisp
(setup life-calendar
  (:autoload life-calendar)
  (setq life-calendar-years 65)
  )
#+end_src
* games
** minesweeper
#+begin_src elisp
(setup mines
  (setq gamegrid-user-score-file-directory (concat nowis/doc-emacs-dir "66-gamegrid-user-score"))
  )
#+end_src
* system-specific-config
** windows-wslg
These codes are used to solve copy & paste problems under wslg inside win10/win11
#+begin_src elisp
;; solve the problem of copying from windows to wslg
(if (string= "Arch" (getenv "WSL_DISTRO_NAME"))
    (progn
      ;; (set-clipboard-coding-system 'gbk-dos)
      ;; solve the problem of copying from wslg to windows
      (defun wsl-copy-region-to-clipboard (start end)
        "Copy region to Windows clipboard."
        (interactive "r")
        (call-process-region start end "wl-copy" nil 0))

      (defun wsl-clipboard-to-string ()
        "Return Windows clipboard as string."
        (let ((coding-system-for-read 'dos))
          (substring; remove added trailing \n
           (shell-command-to-string
            "wl-paste") 0 -1)))
      (defun wsl-paste-from-clipboard (arg)
        "Insert Windows clipboard at point. With prefix ARG, also add to kill-ring"
        (interactive "P")
        (let ((clip (wsl-clipboard-to-string)))
          (insert clip)
          (if arg (kill-new clip))))
      (global-set-key [remap kill-ring-save] #'wsl-copy-region-to-clipboard)
      (global-set-key [remap meow-yank] #'wsl-paste-from-clipboard)
      ))
#+end_src
** android
#+begin_src elisp
(if (eq system-type 'android)
    (progn
      (setq touch-screen-display-keyboard t)
      (setq overriding-text-conversion-style nil)
      ))
(defun android-toggle-keyboard()
  (interactive)
  (if touch-screen-display-keyboard
      (progn
        (setq touch-screen-display-keyboard nil)
        (tool-bar-add-item
         "keyboard-off" 'android-toggle-keyboard
         'android-toggle-keyboard
         :help "Toggle keyboard")
        (message "Disable virtual keyboard"))
    (setq touch-screen-display-keyboard t)
    (tool-bar-add-item
     "keyboard" 'android-toggle-keyboard
     'android-toggle-keyboard
     :help "Toggle keyboard")
    (message "Enable virtual keyboard")))
#+end_src
